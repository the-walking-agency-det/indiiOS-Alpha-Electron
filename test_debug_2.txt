
> indii-os@0.0.0 test
> vitest src/services/agent/AgentIntegration.test.ts


[1m[44m DEV [49m[22m [34mv4.0.15 [39m[90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mUsing partial/invalid config due to validation errors.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mFirebaseError: Firebase: Error (auth/too-many-requests).
    at createErrorInternal [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:499:41[90m)[39m
    at _fail [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:474:11[90m)[39m
    at _performFetchWithErrorHandling [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:961:17[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at _performSignInRequest [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:976:28[90m)[39m
    at signInAnonymously [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:5504:22[90m)[39m {
  code: [32m'auth/too-many-requests'[39m,
  customData: {}
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts
[22m[39m[AgentRegistry] Registered: Marketing Department (marketing)
[AgentRegistry] Registered: Legal Department (legal)
[AgentRegistry] Registered: Finance Department (finance)
[AgentRegistry] Registered: Music Supervisor (music)
[AgentRegistry] Registered: Creative Director (director)
[AgentRegistry] Registered: Video Department (video)
[AgentRegistry] Registered: Social Media Department (social)
[AgentRegistry] Registered: Publicist (publicist)
[AgentRegistry] Registered: Road Manager (road)
[AgentRegistry] Registered: Publishing Department (publishing)
[AgentRegistry] Registered: Licensing Department (licensing)
[AgentRegistry] Registered: Brand Manager (brand)
[AgentRegistry] Registered: Agent Zero (generalist)

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[2025-12-06T14:11:47.440Z]  @firebase/firestore: Firestore (12.6.0): Error using user provided cache. Falling back to memory cache: FirebaseError: [code=unimplemented]: IndexedDB persistence is only available on platforms that support LocalStorage.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: Analyze market trends

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Check this budget

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[Finance Department] Tool Call: analyze_budget { amount: [33m1000[39m, breakdown: [32m'Test'[39m }

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Request 1

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at async Promise.all (index 0)
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:119:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[HistoryManager] agentHistory length: [33m3[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: New Message

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[Marketing Department] Error executing task: TypeError: response.functionCalls is not a function
    at BaseAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/BaseAgent.ts:172:43[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:135:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mDEBUG: historyString: 
You are the Campaign Manager.
    Your role is to design and execute comprehensive marketing campaigns.

    Responsibilities:
    1. Develop strategic campaign concepts.
    2. Create content calendars and distribution plans.
    3. Coordinate messaging across social, email, and web channels.
    4. Analyze campaign performance and adjust strategy.

    Think holistically about the brand's narrative and audience engagement.


        **SUPERPOWERS (Agent Zero Protocol):**
        - **Memory:** Use 'save_memory' to remember important details. Use 'recall_memories' to check for past context.
        - **Reflection:** Use 'verify_output' to double-check your work before finalizing.
        - **Approval:** Use 'request_approval' before taking any public or irreversible action.
        

CONTEXT:
{
  "currentProjectId": "p1",
  "userProfile": {
    "brandKit": {
      "tone": "Professional"
    }
  },
  "brandKit": {
    "tone": "Professional"
  },
  "chatHistory": [
    {
      "id": "1",
      "role": "user",
      "text": "Prev User",
      "timestamp": 100
    },
    {
      "id": "2",
      "role": "model",
      "text": "Prev Model",
      "timestamp": 200
    },
    {
      "id": "4fe44e7c-3f65-4623-b785-9d6240768b04",
      "role": "user",
      "text": "New Message",
      "timestamp": 1765030308579
    },
    {
      "id": "9fc4b760-4271-4234-8bc6-c9bc6f2e5a04",
      "role": "model",
      "text": "",
      "timestamp": 1765030308683,
      "isStreaming": true,
      "thoughts": [
        {
          "id": "8b157331-3dbe-46a8-a236-c56fe584e3f0",
          "text": "Analyzing request: \"New Message...\"",
          "timestamp": 1765030308683,
          "type": "thought"
        }
      ]
    }
  ],
  "memoryContext": "",
  "relevantMemories": [],
  "projectId": "p1"
}

HISTORY:


TASK:
New Message

DEBUG: mockStoreState.agentHistory: [
  {
    "id": "1",
    "role": "user",
    "text": "Prev User",
    "timestamp": 100
  },
  {
    "id": "2",
    "role": "model",
    "text": "Prev Model",
    "timestamp": 200
  },
  {
    "id": "4fe44e7c-3f65-4623-b785-9d6240768b04",
    "role": "user",
    "text": "New Message",
    "timestamp": 1765030308579
  },
  {
    "id": "9fc4b760-4271-4234-8bc6-c9bc6f2e5a04",
    "role": "model",
    "text": "Error executing task: response.functionCalls is not a function",
    "timestamp": 1765030308683,
    "isStreaming": false,
    "thoughts": [
      {
        "id": "8b157331-3dbe-46a8-a236-c56fe584e3f0",
        "text": "Analyzing request: \"New Message...\"",
        "timestamp": 1765030308683,
        "type": "thought"
      },
      {
        "id": "a6c08f36-61fc-4d06-96f6-ff2e4eaa87e4",
        "text": "Generating response...",
        "timestamp": 1765030308683,
        "type": "thought"
      },
      {
        "id": "8d38f35c-83af-46c9-a4fb-6d13b69133f8",
        "text": "Error: response.functionCalls is not a function",
        "timestamp": 1765030308684,
        "type": "thought"
      }
    ]
  }
]

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Get rich

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[Finance Department] Tool Call: make_money_fast {}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Do something crazy

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:176:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[AgentService] Selected Agent: brand (Auto)
[AgentExecutor] Executing with agent: Brand Manager (brand)
[Brand Manager] Received task: Verify this

 [31mâ¯[39m src/services/agent/AgentIntegration.test.ts [2m([22m[2m7 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 1591[2mms[22m[39m
       [33m[2mâœ“[22m[39m should correctly orchestrate, execute, and return response for a specialist [33m 894[2mms[22m[39m
       [32mâœ“[39m should handle tool execution cycles (Thinking -> Tool -> Response)[32m 107[2mms[22m[39m
       [32mâœ“[39m should prevent concurrent agent executions (Lock Mechanism)[32m 176[2mms[22m[39m
[31m       [31mÃ—[31m should accumulate context correctly across multiple turns[39m[32m 114[2mms[22m[39m
       [32mâœ“[39m should handle hallucinated tool calls gracefully[32m 89[2mms[22m[39m
       [32mâœ“[39m should route to Generalist if Orchestrator hallucinations an invalid ID[32m 113[2mms[22m[39m
       [32mâœ“[39m should gracefully handle agent execution failure[32m 95[2mms[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 1 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m src/services/agent/AgentIntegration.test.ts[2m > [22mAgent Architecture Integration (Hardened)[2m > [22mState & Concurrency (Stress Test)[2m > [22mshould accumulate context correctly across multiple turns
[31m[1mAssertionError[22m: expected '\nYou are the Campaign Manager.\n    â€¦' to contain 'User: Prev User'[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- [7mUser[27m: Prev User[39m
[31m+[39m
[31m+ You are the Campaign Manager.[39m
[31m+     Your role is to design and execute comprehensive marketing campaigns.[39m
[31m+[39m
[31m+     Responsibilities:[39m
[31m+     1. Develop strategic campaign concepts.[39m
[31m+     2. Create content calendars and distribution plans.[39m
[31m+     3. Coordinate messaging across social, email, and web channels.[39m
[31m+     4. Analyze campaign performance and adjust strategy.[39m
[31m+[39m
[31m+     Think holistically about the brand's narrative and audience engagement.[39m
[31m+[39m
[31m+[39m
[31m+         **SUPERPOWERS (Agent Zero Protocol):**[39m
[31m+         - **Memory:** Use 'save_memory' to remember important details. Use 'recall_memories' to check for past context.[39m
[31m+         - **Reflection:** Use 'verify_output' to double-check your work before finalizing.[39m
[31m+         - **Approval:** Use 'request_approval' before taking any public or irreversible action.[39m
[31m+         [39m
[31m+[39m
[31m+ CONTEXT:[39m
[31m+ {[39m
[31m+   "currentProjectId": "p1",[39m
[31m+   "userProfile": {[39m
[31m+     "brandKit": {[39m
[31m+       "tone": "Professional"[39m
[31m+     }[39m
[31m+   },[39m
[31m+   "brandKit": {[39m
[31m+     "tone": "Professional"[39m
[31m+   },[39m
[31m+   "chatHistory": [[39m
[31m+     {[39m
[31m+       "id": "1",[39m
[31m+       "role": "user",[39m
[31m+ [7m      "text"[27m: [7m"[27mPrev User[7m",[27m[39m
[31m+       "timestamp": 100[39m
[31m+     },[39m
[31m+     {[39m
[31m+       "id": "2",[39m
[31m+       "role": "model",[39m
[31m+       "text": "Prev Model",[39m
[31m+       "timestamp": 200[39m
[31m+     },[39m
[31m+     {[39m
[31m+       "id": "4fe44e7c-3f65-4623-b785-9d6240768b04",[39m
[31m+       "role": "user",[39m
[31m+       "text": "New Message",[39m
[31m+       "timestamp": 1765030308579[39m
[31m+     },[39m
[31m+     {[39m
[31m+       "id": "9fc4b760-4271-4234-8bc6-c9bc6f2e5a04",[39m
[31m+       "role": "model",[39m
[31m+       "text": "",[39m
[31m+       "timestamp": 1765030308683,[39m
[31m+       "isStreaming": true,[39m
[31m+       "thoughts": [[39m
[31m+         {[39m
[31m+           "id": "8b157331-3dbe-46a8-a236-c56fe584e3f0",[39m
[31m+           "text": "Analyzing request: \"New Message...\"",[39m
[31m+           "timestamp": 1765030308683,[39m
[31m+           "type": "thought"[39m
[31m+         }[39m
[31m+       ][39m
[31m+     }[39m
[31m+   ],[39m
[31m+   "memoryContext": "",[39m
[31m+   "relevantMemories": [],[39m
[31m+   "projectId": "p1"[39m
[31m+ }[39m
[31m+[39m
[31m+ HISTORY:[39m
[31m+[39m
[31m+[39m
[31m+ TASK:[39m
[31m+ New Message[39m
[31m+[39m

[36m [2mâ¯[22m src/services/agent/AgentIntegration.test.ts:[2m146:35[22m[39m
    [90m144| [39m            // We need to verify that ContextPipeline built the stringâ€¦
    [90m145| [39m            // The mock store has the messages, ContextPipeline reads â€¦
    [90m146| [39m            [34mexpect[39m(historyString)[33m.[39m[34mtoContain[39m([32m'User: Prev User'[39m)[33m;[39m
    [90m   | [39m                                  [31m^[39m
    [90m147| [39m            [34mexpect[39m(historyString)[33m.[39m[34mtoContain[39m([32m'Assistant: Prev Model'[39m)[33m;[39m
    [90m148| [39m        })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/1]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m6 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 09:11:35
[2m   Duration [22m 13.46s[2m (transform 2.55s, setup 884ms, import 3.70s, tests 1.59s, environment 5.48s)[22m

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2msrc/core/store/slices/authSlice.ts [22m[34mx1 [34m[39m
       [2m Filename pattern: [22m[34msrc/services/agent/AgentIntegration.test.ts[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mUsing partial/invalid config due to validation errors.

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts
[22m[39m[AgentRegistry] Registered: Marketing Department (marketing)
[AgentRegistry] Registered: Legal Department (legal)
[AgentRegistry] Registered: Finance Department (finance)
[AgentRegistry] Registered: Music Supervisor (music)
[AgentRegistry] Registered: Creative Director (director)
[AgentRegistry] Registered: Video Department (video)
[AgentRegistry] Registered: Social Media Department (social)
[AgentRegistry] Registered: Publicist (publicist)
[AgentRegistry] Registered: Road Manager (road)
[AgentRegistry] Registered: Publishing Department (publishing)
[AgentRegistry] Registered: Licensing Department (licensing)
[AgentRegistry] Registered: Brand Manager (brand)
[AgentRegistry] Registered: Agent Zero (generalist)

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mFirebaseError: Firebase: Error (auth/too-many-requests).
    at createErrorInternal [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:499:41[90m)[39m
    at _fail [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:474:11[90m)[39m
    at _performFetchWithErrorHandling [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:961:17[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at _performSignInRequest [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:976:28[90m)[39m
    at signInAnonymously [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:5504:22[90m)[39m {
  code: [32m'auth/too-many-requests'[39m,
  customData: {}
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[2025-12-06T14:12:07.388Z]  @firebase/firestore: Firestore (12.6.0): Error using user provided cache. Falling back to memory cache: FirebaseError: [code=unimplemented]: IndexedDB persistence is only available on platforms that support LocalStorage.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: Analyze market trends

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Check this budget

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[Finance Department] Tool Call: analyze_budget { amount: [33m1000[39m, breakdown: [32m'Test'[39m }

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Request 1

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at async Promise.all (index 0)
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:119:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[HistoryManager] agentHistory length: [33m3[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: New Message

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[Marketing Department] Error executing task: TypeError: response.functionCalls is not a function
    at BaseAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/BaseAgent.ts:172:43[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:135:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mDEBUG: historyString: 
You are the Campaign Manager.
    Your role is to design and execute comprehensive marketing campaigns.

    Responsibilities:
    1. Develop strategic campaign concepts.
    2. Create content calendars and distribution plans.
    3. Coordinate messaging across social, email, and web channels.
    4. Analyze campaign performance and adjust strategy.

    Think holistically about the brand's narrative and audience engagement.


        **SUPERPOWERS (Agent Zero Protocol):**
        - **Memory:** Use 'save_memory' to remember important details. Use 'recall_memories' to check for past context.
        - **Reflection:** Use 'verify_output' to double-check your work before finalizing.
        - **Approval:** Use 'request_approval' before taking any public or irreversible action.
        

CONTEXT:
{
  "currentProjectId": "p1",
  "userProfile": {
    "brandKit": {
      "tone": "Professional"
    }
  },
  "brandKit": {
    "tone": "Professional"
  },
  "chatHistory": [
    {
      "id": "1",
      "role": "user",
      "text": "Prev User",
      "timestamp": 100
    },
    {
      "id": "2",
      "role": "model",
      "text": "Prev Model",
      "timestamp": 200
    },
    {
      "id": "cca99976-4c11-48bd-b005-1d1ff1b31087",
      "role": "user",
      "text": "New Message",
      "timestamp": 1765030329752
    },
    {
      "id": "39c9ec3c-cbf8-4279-9b99-f103043ddab0",
      "role": "model",
      "text": "",
      "timestamp": 1765030329967,
      "isStreaming": true,
      "thoughts": [
        {
          "id": "1eefd028-4ce2-4e72-95ab-80cfc52130ef",
          "text": "Analyzing request: \"New Message...\"",
          "timestamp": 1765030329971,
          "type": "thought"
        }
      ]
    }
  ],
  "memoryContext": "",
  "relevantMemories": [],
  "projectId": "p1"
}

HISTORY:


TASK:
New Message

DEBUG: mockStoreState.agentHistory: [
  {
    "id": "1",
    "role": "user",
    "text": "Prev User",
    "timestamp": 100
  },
  {
    "id": "2",
    "role": "model",
    "text": "Prev Model",
    "timestamp": 200
  },
  {
    "id": "cca99976-4c11-48bd-b005-1d1ff1b31087",
    "role": "user",
    "text": "New Message",
    "timestamp": 1765030329752
  },
  {
    "id": "39c9ec3c-cbf8-4279-9b99-f103043ddab0",
    "role": "model",
    "text": "Error executing task: response.functionCalls is not a function",
    "timestamp": 1765030329967,
    "isStreaming": false,
    "thoughts": [
      {
        "id": "1eefd028-4ce2-4e72-95ab-80cfc52130ef",
        "text": "Analyzing request: \"New Message...\"",
        "timestamp": 1765030329971,
        "type": "thought"
      },
      {
        "id": "c4f80b92-e170-4863-8253-f8c95ce0a831",
        "text": "Generating response...",
        "timestamp": 1765030329971,
        "type": "thought"
      },
      {
        "id": "e42478e8-c92d-498c-a490-a624e2a27d40",
        "text": "Error: response.functionCalls is not a function",
        "timestamp": 1765030329972,
        "type": "thought"
      }
    ]
  }
]

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Get rich

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[Finance Department] Tool Call: make_money_fast {}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Do something crazy

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:176:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[AgentService] Selected Agent: brand (Auto)
[AgentExecutor] Executing with agent: Brand Manager (brand)
[Brand Manager] Received task: Verify this

 [31mâ¯[39m src/services/agent/AgentIntegration.test.ts [2m([22m[2m7 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 3414[2mms[22m[39m
       [33m[2mâœ“[22m[39m should correctly orchestrate, execute, and return response for a specialist [33m 1680[2mms[22m[39m
       [32mâœ“[39m should handle tool execution cycles (Thinking -> Tool -> Response)[32m 261[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent concurrent agent executions (Lock Mechanism) [33m 327[2mms[22m[39m
[31m       [31mÃ—[31m should accumulate context correctly across multiple turns[39m[32m 230[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle hallucinated tool calls gracefully [33m 419[2mms[22m[39m
       [32mâœ“[39m should route to Generalist if Orchestrator hallucinations an invalid ID[32m 163[2mms[22m[39m
       [32mâœ“[39m should gracefully handle agent execution failure[32m 106[2mms[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 1 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m src/services/agent/AgentIntegration.test.ts[2m > [22mAgent Architecture Integration (Hardened)[2m > [22mState & Concurrency (Stress Test)[2m > [22mshould accumulate context correctly across multiple turns
[31m[1mAssertionError[22m: expected '\nYou are the Campaign Manager.\n    â€¦' to contain 'User: Prev User'[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- [7mUser[27m: Prev User[39m
[31m+[39m
[31m+ You are the Campaign Manager.[39m
[31m+     Your role is to design and execute comprehensive marketing campaigns.[39m
[31m+[39m
[31m+     Responsibilities:[39m
[31m+     1. Develop strategic campaign concepts.[39m
[31m+     2. Create content calendars and distribution plans.[39m
[31m+     3. Coordinate messaging across social, email, and web channels.[39m
[31m+     4. Analyze campaign performance and adjust strategy.[39m
[31m+[39m
[31m+     Think holistically about the brand's narrative and audience engagement.[39m
[31m+[39m
[31m+[39m
[31m+         **SUPERPOWERS (Agent Zero Protocol):**[39m
[31m+         - **Memory:** Use 'save_memory' to remember important details. Use 'recall_memories' to check for past context.[39m
[31m+         - **Reflection:** Use 'verify_output' to double-check your work before finalizing.[39m
[31m+         - **Approval:** Use 'request_approval' before taking any public or irreversible action.[39m
[31m+         [39m
[31m+[39m
[31m+ CONTEXT:[39m
[31m+ {[39m
[31m+   "currentProjectId": "p1",[39m
[31m+   "userProfile": {[39m
[31m+     "brandKit": {[39m
[31m+       "tone": "Professional"[39m
[31m+     }[39m
[31m+   },[39m
[31m+   "brandKit": {[39m
[31m+     "tone": "Professional"[39m
[31m+   },[39m
[31m+   "chatHistory": [[39m
[31m+     {[39m
[31m+       "id": "1",[39m
[31m+       "role": "user",[39m
[31m+ [7m      "text"[27m: [7m"[27mPrev User[7m",[27m[39m
[31m+       "timestamp": 100[39m
[31m+     },[39m
[31m+     {[39m
[31m+       "id": "2",[39m
[31m+       "role": "model",[39m
[31m+       "text": "Prev Model",[39m
[31m+       "timestamp": 200[39m
[31m+     },[39m
[31m+     {[39m
[31m+       "id": "cca99976-4c11-48bd-b005-1d1ff1b31087",[39m
[31m+       "role": "user",[39m
[31m+       "text": "New Message",[39m
[31m+       "timestamp": 1765030329752[39m
[31m+     },[39m
[31m+     {[39m
[31m+       "id": "39c9ec3c-cbf8-4279-9b99-f103043ddab0",[39m
[31m+       "role": "model",[39m
[31m+       "text": "",[39m
[31m+       "timestamp": 1765030329967,[39m
[31m+       "isStreaming": true,[39m
[31m+       "thoughts": [[39m
[31m+         {[39m
[31m+           "id": "1eefd028-4ce2-4e72-95ab-80cfc52130ef",[39m
[31m+           "text": "Analyzing request: \"New Message...\"",[39m
[31m+           "timestamp": 1765030329971,[39m
[31m+           "type": "thought"[39m
[31m+         }[39m
[31m+       ][39m
[31m+     }[39m
[31m+   ],[39m
[31m+   "memoryContext": "",[39m
[31m+   "relevantMemories": [],[39m
[31m+   "projectId": "p1"[39m
[31m+ }[39m
[31m+[39m
[31m+ HISTORY:[39m
[31m+[39m
[31m+[39m
[31m+ TASK:[39m
[31m+ New Message[39m
[31m+[39m

[36m [2mâ¯[22m src/services/agent/AgentIntegration.test.ts:[2m146:35[22m[39m
    [90m144| [39m            // We need to verify that ContextPipeline built the stringâ€¦
    [90m145| [39m            // The mock store has the messages, ContextPipeline reads â€¦
    [90m146| [39m            [34mexpect[39m(historyString)[33m.[39m[34mtoContain[39m([32m'User: Prev User'[39m)[33m;[39m
    [90m   | [39m                                  [31m^[39m
    [90m147| [39m            [34mexpect[39m(historyString)[33m.[39m[34mtoContain[39m([32m'Assistant: Prev Model'[39m)[33m;[39m
    [90m148| [39m        })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/1]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m6 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 09:11:51
[2m   Duration [22m 9.50s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2msrc/services/agent/components/AgentExecutor.ts [22m[34mx2 [34m[39m
       [2m Filename pattern: [22m[34msrc/services/agent/AgentIntegration.test.ts[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mUsing partial/invalid config due to validation errors.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mFirebaseError: Firebase: Error (auth/too-many-requests).
    at createErrorInternal [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:499:41[90m)[39m
    at _fail [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:474:11[90m)[39m
    at _performFetchWithErrorHandling [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:961:17[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at _performSignInRequest [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:976:28[90m)[39m
    at signInAnonymously [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:5504:22[90m)[39m {
  code: [32m'auth/too-many-requests'[39m,
  customData: {}
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts
[22m[39m[AgentRegistry] Registered: Marketing Department (marketing)
[AgentRegistry] Registered: Legal Department (legal)
[AgentRegistry] Registered: Finance Department (finance)
[AgentRegistry] Registered: Music Supervisor (music)
[AgentRegistry] Registered: Creative Director (director)
[AgentRegistry] Registered: Video Department (video)
[AgentRegistry] Registered: Social Media Department (social)
[AgentRegistry] Registered: Publicist (publicist)
[AgentRegistry] Registered: Road Manager (road)
[AgentRegistry] Registered: Publishing Department (publishing)
[AgentRegistry] Registered: Licensing Department (licensing)
[AgentRegistry] Registered: Brand Manager (brand)
[AgentRegistry] Registered: Agent Zero (generalist)

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[2025-12-06T14:13:17.417Z]  @firebase/firestore: Firestore (12.6.0): Error using user provided cache. Falling back to memory cache: FirebaseError: [code=unimplemented]: IndexedDB persistence is only available on platforms that support LocalStorage.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: Analyze market trends

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Check this budget

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[Finance Department] Tool Call: analyze_budget { amount: [33m1000[39m, breakdown: [32m'Test'[39m }

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Request 1

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at async Promise.all (index 0)
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:119:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[HistoryManager] agentHistory length: [33m3[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: New Message

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[Marketing Department] Error executing task: TypeError: response.functionCalls is not a function
    at BaseAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/BaseAgent.ts:172:43[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:135:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mDEBUG: historyString: 
You are the Campaign Manager.
    Your role is to design and execute comprehensive marketing campaigns.

    Responsibilities:
    1. Develop strategic campaign concepts.
    2. Create content calendars and distribution plans.
    3. Coordinate messaging across social, email, and web channels.
    4. Analyze campaign performance and adjust strategy.

    Think holistically about the brand's narrative and audience engagement.


        **SUPERPOWERS (Agent Zero Protocol):**
        - **Memory:** Use 'save_memory' to remember important details. Use 'recall_memories' to check for past context.
        - **Reflection:** Use 'verify_output' to double-check your work before finalizing.
        - **Approval:** Use 'request_approval' before taking any public or irreversible action.
        

CONTEXT:
{
  "currentProjectId": "p1",
  "userProfile": {
    "brandKit": {
      "tone": "Professional"
    }
  },
  "brandKit": {
    "tone": "Professional"
  },
  "chatHistory": [
    {
      "id": "1",
      "role": "user",
      "text": "Prev User",
      "timestamp": 100
    },
    {
      "id": "2",
      "role": "model",
      "text": "Prev Model",
      "timestamp": 200
    },
    {
      "id": "4a453299-1f5f-4f13-9ece-f3dac7b38da5",
      "role": "user",
      "text": "New Message",
      "timestamp": 1765030399141
    },
    {
      "id": "4a088da5-8c09-4cfe-a92b-899cf8687ad6",
      "role": "model",
      "text": "",
      "timestamp": 1765030399251,
      "isStreaming": true,
      "thoughts": [
        {
          "id": "94daa1ef-d441-4140-9b5f-3ca796c3bff3",
          "text": "Analyzing request: \"New Message...\"",
          "timestamp": 1765030399251,
          "type": "thought"
        }
      ]
    }
  ],
  "chatHistoryString": "User: Prev User\nAssistant: Prev Model\nUser: New Message",
  "memoryContext": "",
  "relevantMemories": [],
  "projectId": "p1"
}

HISTORY:
User: Prev User
Assistant: Prev Model
User: New Message

TASK:
New Message

DEBUG: mockStoreState.agentHistory: [
  {
    "id": "1",
    "role": "user",
    "text": "Prev User",
    "timestamp": 100
  },
  {
    "id": "2",
    "role": "model",
    "text": "Prev Model",
    "timestamp": 200
  },
  {
    "id": "4a453299-1f5f-4f13-9ece-f3dac7b38da5",
    "role": "user",
    "text": "New Message",
    "timestamp": 1765030399141
  },
  {
    "id": "4a088da5-8c09-4cfe-a92b-899cf8687ad6",
    "role": "model",
    "text": "Error executing task: response.functionCalls is not a function",
    "timestamp": 1765030399251,
    "isStreaming": false,
    "thoughts": [
      {
        "id": "94daa1ef-d441-4140-9b5f-3ca796c3bff3",
        "text": "Analyzing request: \"New Message...\"",
        "timestamp": 1765030399251,
        "type": "thought"
      },
      {
        "id": "9c7095f9-8271-4b6e-81f2-bb9d30d3ed6b",
        "text": "Generating response...",
        "timestamp": 1765030399251,
        "type": "thought"
      },
      {
        "id": "855778e6-c562-43e7-a0f8-6bbb17ed4779",
        "text": "Error: response.functionCalls is not a function",
        "timestamp": 1765030399251,
        "type": "thought"
      }
    ]
  }
]

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Get rich

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[Finance Department] Tool Call: make_money_fast {}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Do something crazy

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:176:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[AgentService] Selected Agent: brand (Auto)
[AgentExecutor] Executing with agent: Brand Manager (brand)
[Brand Manager] Received task: Verify this

 [32mâœ“[39m src/services/agent/AgentIntegration.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 2219[2mms[22m[39m
       [33m[2mâœ“[22m[39m should correctly orchestrate, execute, and return response for a specialist [33m 634[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent concurrent agent executions (Lock Mechanism) [33m 1021[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m7 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 09:13:09
[2m   Duration [22m 5.86s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2msrc/services/agent/components/HistoryManager.ts [22m[34mx3 [34m[39m
       [2m Filename pattern: [22m[34msrc/services/agent/AgentIntegration.test.ts[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mUsing partial/invalid config due to validation errors.

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts
[22m[39m[AgentRegistry] Registered: Marketing Department (marketing)
[AgentRegistry] Registered: Legal Department (legal)
[AgentRegistry] Registered: Finance Department (finance)
[AgentRegistry] Registered: Music Supervisor (music)
[AgentRegistry] Registered: Creative Director (director)
[AgentRegistry] Registered: Video Department (video)
[AgentRegistry] Registered: Social Media Department (social)
[AgentRegistry] Registered: Publicist (publicist)
[AgentRegistry] Registered: Road Manager (road)
[AgentRegistry] Registered: Publishing Department (publishing)
[AgentRegistry] Registered: Licensing Department (licensing)
[AgentRegistry] Registered: Brand Manager (brand)
[AgentRegistry] Registered: Agent Zero (generalist)

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[2025-12-06T14:13:28.704Z]  @firebase/firestore: Firestore (12.6.0): Error using user provided cache. Falling back to memory cache: FirebaseError: [code=unimplemented]: IndexedDB persistence is only available on platforms that support LocalStorage.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mFirebaseError: Firebase: Error (auth/too-many-requests).
    at createErrorInternal [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:499:41[90m)[39m
    at _fail [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:474:11[90m)[39m
    at _performFetchWithErrorHandling [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:961:17[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at _performSignInRequest [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:976:28[90m)[39m
    at signInAnonymously [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:5504:22[90m)[39m {
  code: [32m'auth/too-many-requests'[39m,
  customData: {}
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: Analyze market trends

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Check this budget

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[Finance Department] Tool Call: analyze_budget { amount: [33m1000[39m, breakdown: [32m'Test'[39m }

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Request 1

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at async Promise.all (index 0)
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:119:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: New Message

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[Marketing Department] Error executing task: TypeError: response.functionCalls is not a function
    at BaseAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/BaseAgent.ts:172:43[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:135:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mDEBUG: historyString: 
You are the Campaign Manager.
    Your role is to design and execute comprehensive marketing campaigns.

    Responsibilities:
    1. Develop strategic campaign concepts.
    2. Create content calendars and distribution plans.
    3. Coordinate messaging across social, email, and web channels.
    4. Analyze campaign performance and adjust strategy.

    Think holistically about the brand's narrative and audience engagement.


        **SUPERPOWERS (Agent Zero Protocol):**
        - **Memory:** Use 'save_memory' to remember important details. Use 'recall_memories' to check for past context.
        - **Reflection:** Use 'verify_output' to double-check your work before finalizing.
        - **Approval:** Use 'request_approval' before taking any public or irreversible action.
        

CONTEXT:
{
  "currentProjectId": "p1",
  "userProfile": {
    "brandKit": {
      "tone": "Professional"
    }
  },
  "brandKit": {
    "tone": "Professional"
  },
  "chatHistory": [
    {
      "id": "1",
      "role": "user",
      "text": "Prev User",
      "timestamp": 100
    },
    {
      "id": "2",
      "role": "model",
      "text": "Prev Model",
      "timestamp": 200
    },
    {
      "id": "4cb50b3e-2bea-4010-8015-0ec8be81a748",
      "role": "user",
      "text": "New Message",
      "timestamp": 1765030410254
    },
    {
      "id": "14828e0c-8514-4069-b696-75f1da726af9",
      "role": "model",
      "text": "",
      "timestamp": 1765030410334,
      "isStreaming": true,
      "thoughts": [
        {
          "id": "851a42be-7340-40cf-a485-d8451beeaaaa",
          "text": "Analyzing request: \"New Message...\"",
          "timestamp": 1765030410334,
          "type": "thought"
        }
      ]
    }
  ],
  "chatHistoryString": "User: Prev User\nAssistant: Prev Model\nUser: New Message",
  "memoryContext": "",
  "relevantMemories": [],
  "projectId": "p1"
}

HISTORY:
User: Prev User
Assistant: Prev Model
User: New Message

TASK:
New Message

DEBUG: mockStoreState.agentHistory: [
  {
    "id": "1",
    "role": "user",
    "text": "Prev User",
    "timestamp": 100
  },
  {
    "id": "2",
    "role": "model",
    "text": "Prev Model",
    "timestamp": 200
  },
  {
    "id": "4cb50b3e-2bea-4010-8015-0ec8be81a748",
    "role": "user",
    "text": "New Message",
    "timestamp": 1765030410254
  },
  {
    "id": "14828e0c-8514-4069-b696-75f1da726af9",
    "role": "model",
    "text": "Error executing task: response.functionCalls is not a function",
    "timestamp": 1765030410334,
    "isStreaming": false,
    "thoughts": [
      {
        "id": "851a42be-7340-40cf-a485-d8451beeaaaa",
        "text": "Analyzing request: \"New Message...\"",
        "timestamp": 1765030410334,
        "type": "thought"
      },
      {
        "id": "3a3154a2-352b-4455-ae7c-c3b801a24089",
        "text": "Generating response...",
        "timestamp": 1765030410334,
        "type": "thought"
      },
      {
        "id": "8d169d5d-b651-4b21-9274-687d0b69c4cc",
        "text": "Error: response.functionCalls is not a function",
        "timestamp": 1765030410335,
        "type": "thought"
      }
    ]
  }
]

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Get rich

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[Finance Department] Tool Call: make_money_fast {}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Do something crazy

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:176:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[AgentService] Selected Agent: brand (Auto)
[AgentExecutor] Executing with agent: Brand Manager (brand)
[Brand Manager] Received task: Verify this

 [32mâœ“[39m src/services/agent/AgentIntegration.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 2224[2mms[22m[39m
       [33m[2mâœ“[22m[39m should correctly orchestrate, execute, and return response for a specialist [33m 1402[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m7 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 09:13:19
[2m   Duration [22m 6.37s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2msrc/services/agent/AgentIntegration.test.ts [22m[34mx4 [34m[39m
       [2m Filename pattern: [22m[34msrc/services/agent/AgentIntegration.test.ts[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mUsing partial/invalid config due to validation errors.

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts
[22m[39m[AgentRegistry] Registered: Marketing Department (marketing)
[AgentRegistry] Registered: Legal Department (legal)
[AgentRegistry] Registered: Finance Department (finance)
[AgentRegistry] Registered: Music Supervisor (music)
[AgentRegistry] Registered: Creative Director (director)
[AgentRegistry] Registered: Video Department (video)
[AgentRegistry] Registered: Social Media Department (social)
[AgentRegistry] Registered: Publicist (publicist)
[AgentRegistry] Registered: Road Manager (road)
[AgentRegistry] Registered: Publishing Department (publishing)
[AgentRegistry] Registered: Licensing Department (licensing)
[AgentRegistry] Registered: Brand Manager (brand)
[AgentRegistry] Registered: Agent Zero (generalist)

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[2025-12-06T14:13:34.783Z]  @firebase/firestore: Firestore (12.6.0): Error using user provided cache. Falling back to memory cache: FirebaseError: [code=unimplemented]: IndexedDB persistence is only available on platforms that support LocalStorage.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mFirebaseError: Firebase: Error (auth/too-many-requests).
    at createErrorInternal [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:499:41[90m)[39m
    at _fail [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:474:11[90m)[39m
    at _performFetchWithErrorHandling [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:961:17[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at _performSignInRequest [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:976:28[90m)[39m
    at signInAnonymously [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:5504:22[90m)[39m {
  code: [32m'auth/too-many-requests'[39m,
  customData: {}
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: Analyze market trends

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Check this budget

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[Finance Department] Tool Call: analyze_budget { amount: [33m1000[39m, breakdown: [32m'Test'[39m }

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Request 1

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at async Promise.all (index 0)
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:119:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: New Message

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[Marketing Department] Error executing task: TypeError: response.functionCalls is not a function
    at BaseAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/BaseAgent.ts:172:43[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:135:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Get rich

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[Finance Department] Tool Call: make_money_fast {}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Do something crazy

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:173:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[AgentService] Selected Agent: brand (Auto)
[AgentExecutor] Executing with agent: Brand Manager (brand)
[Brand Manager] Received task: Verify this

 [32mâœ“[39m src/services/agent/AgentIntegration.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 1511[2mms[22m[39m
       [33m[2mâœ“[22m[39m should correctly orchestrate, execute, and return response for a specialist [33m 798[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m7 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 09:13:30
[2m   Duration [22m 3.26s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2msrc/services/agent/specialists/verification.test.ts [22m[34mx5 [34m[39m
       [2m Filename pattern: [22m[34msrc/services/agent/AgentIntegration.test.ts[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mUsing partial/invalid config due to validation errors.

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts
[22m[39m[AgentRegistry] Registered: Marketing Department (marketing)
[AgentRegistry] Registered: Legal Department (legal)
[AgentRegistry] Registered: Finance Department (finance)
[AgentRegistry] Registered: Music Supervisor (music)
[AgentRegistry] Registered: Creative Director (director)
[AgentRegistry] Registered: Video Department (video)
[AgentRegistry] Registered: Social Media Department (social)
[AgentRegistry] Registered: Publicist (publicist)
[AgentRegistry] Registered: Road Manager (road)
[AgentRegistry] Registered: Publishing Department (publishing)
[AgentRegistry] Registered: Licensing Department (licensing)
[AgentRegistry] Registered: Brand Manager (brand)
[AgentRegistry] Registered: Agent Zero (generalist)

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mFirebaseError: Firebase: Error (auth/too-many-requests).
    at createErrorInternal [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:499:41[90m)[39m
    at _fail [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:474:11[90m)[39m
    at _performFetchWithErrorHandling [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:961:17[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at _performSignInRequest [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:976:28[90m)[39m
    at signInAnonymously [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:5504:22[90m)[39m {
  code: [32m'auth/too-many-requests'[39m,
  customData: {}
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[2025-12-06T14:21:02.653Z]  @firebase/firestore: Firestore (12.6.0): Error using user provided cache. Falling back to memory cache: FirebaseError: [code=unimplemented]: IndexedDB persistence is only available on platforms that support LocalStorage.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: Analyze market trends

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Check this budget

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[Finance Department] Tool Call: analyze_budget { amount: [33m1000[39m, breakdown: [32m'Test'[39m }

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Request 1

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at async Promise.all (index 0)
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:119:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: New Message

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[Marketing Department] Error executing task: TypeError: response.functionCalls is not a function
    at BaseAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/BaseAgent.ts:172:43[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:135:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Get rich

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[Finance Department] Tool Call: make_money_fast {}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Do something crazy

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:173:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[AgentService] Selected Agent: brand (Auto)
[AgentExecutor] Executing with agent: Brand Manager (brand)
[Brand Manager] Received task: Verify this

 [32mâœ“[39m src/services/agent/AgentIntegration.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 2371[2mms[22m[39m
       [33m[2mâœ“[22m[39m should correctly orchestrate, execute, and return response for a specialist [33m 1451[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m7 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 09:20:50
[2m   Duration [22m 8.09s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2msrc/services/agent/specialists/verification.test.ts [22m[34mx6 [34m[39m
       [2m Filename pattern: [22m[34msrc/services/agent/AgentIntegration.test.ts[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mUsing partial/invalid config due to validation errors.

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts
[22m[39m[AgentRegistry] Registered: Marketing Department (marketing)
[AgentRegistry] Registered: Legal Department (legal)
[AgentRegistry] Registered: Finance Department (finance)
[AgentRegistry] Registered: Music Supervisor (music)
[AgentRegistry] Registered: Creative Director (director)
[AgentRegistry] Registered: Video Department (video)
[AgentRegistry] Registered: Social Media Department (social)
[AgentRegistry] Registered: Publicist (publicist)
[AgentRegistry] Registered: Road Manager (road)
[AgentRegistry] Registered: Publishing Department (publishing)
[AgentRegistry] Registered: Licensing Department (licensing)
[AgentRegistry] Registered: Brand Manager (brand)
[AgentRegistry] Registered: Agent Zero (generalist)

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[2025-12-06T14:21:11.574Z]  @firebase/firestore: Firestore (12.6.0): Error using user provided cache. Falling back to memory cache: FirebaseError: [code=unimplemented]: IndexedDB persistence is only available on platforms that support LocalStorage.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mFirebaseError: Firebase: Error (auth/too-many-requests).
    at createErrorInternal [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:499:41[90m)[39m
    at _fail [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:474:11[90m)[39m
    at _performFetchWithErrorHandling [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:961:17[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at _performSignInRequest [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:976:28[90m)[39m
    at signInAnonymously [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:5504:22[90m)[39m {
  code: [32m'auth/too-many-requests'[39m,
  customData: {}
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: Analyze market trends

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Check this budget

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[Finance Department] Tool Call: analyze_budget { amount: [33m1000[39m, breakdown: [32m'Test'[39m }

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Request 1

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at async Promise.all (index 0)
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:119:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: New Message

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[Marketing Department] Error executing task: TypeError: response.functionCalls is not a function
    at BaseAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/BaseAgent.ts:172:43[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:135:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Get rich

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[Finance Department] Tool Call: make_money_fast {}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Do something crazy

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:173:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[AgentService] Selected Agent: brand (Auto)
[AgentExecutor] Executing with agent: Brand Manager (brand)
[Brand Manager] Received task: Verify this

 [32mâœ“[39m src/services/agent/AgentIntegration.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 1266[2mms[22m[39m
       [33m[2mâœ“[22m[39m should correctly orchestrate, execute, and return response for a specialist [33m 588[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m7 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 09:21:05
[2m   Duration [22m 3.98s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
