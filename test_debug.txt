
> indii-os@0.0.0 test
> vitest src/services/agent/AgentIntegration.test.ts


[1m[44m DEV [49m[22m [34mv4.0.15 [39m[90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mUsing partial/invalid config due to validation errors.

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts
[22m[39m[AgentRegistry] Registered: Marketing Department (marketing)
[AgentRegistry] Registered: Legal Department (legal)
[AgentRegistry] Registered: Finance Department (finance)
[AgentRegistry] Registered: Music Supervisor (music)
[AgentRegistry] Registered: Creative Director (director)
[AgentRegistry] Registered: Video Department (video)
[AgentRegistry] Registered: Social Media Department (social)
[AgentRegistry] Registered: Publicist (publicist)
[AgentRegistry] Registered: Road Manager (road)
[AgentRegistry] Registered: Publishing Department (publishing)
[AgentRegistry] Registered: Licensing Department (licensing)
[AgentRegistry] Registered: Brand Manager (brand)
[AgentRegistry] Registered: Agent Zero (generalist)

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[2025-12-06T14:10:35.016Z]  @firebase/firestore: Firestore (12.6.0): Error using user provided cache. Falling back to memory cache: FirebaseError: [code=unimplemented]: IndexedDB persistence is only available on platforms that support LocalStorage.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: Analyze market trends

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39mFirebaseError: Firebase: Error (auth/too-many-requests).
    at createErrorInternal [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:499:41[90m)[39m
    at _fail [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:474:11[90m)[39m
    at _performFetchWithErrorHandling [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:961:17[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at _performSignInRequest [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:976:28[90m)[39m
    at signInAnonymously [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:5504:22[90m)[39m {
  code: [32m'auth/too-many-requests'[39m,
  customData: {}
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Check this budget

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[Finance Department] Tool Call: analyze_budget { amount: [33m1000[39m, breakdown: [32m'Test'[39m }

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Request 1

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at async Promise.all (index 0)
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:119:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: New Message

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[Marketing Department] Error executing task: TypeError: response.functionCalls is not a function
    at BaseAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/BaseAgent.ts:172:43[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:135:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mDEBUG: historyString: 
You are the Campaign Manager.
    Your role is to design and execute comprehensive marketing campaigns.

    Responsibilities:
    1. Develop strategic campaign concepts.
    2. Create content calendars and distribution plans.
    3. Coordinate messaging across social, email, and web channels.
    4. Analyze campaign performance and adjust strategy.

    Think holistically about the brand's narrative and audience engagement.


        **SUPERPOWERS (Agent Zero Protocol):**
        - **Memory:** Use 'save_memory' to remember important details. Use 'recall_memories' to check for past context.
        - **Reflection:** Use 'verify_output' to double-check your work before finalizing.
        - **Approval:** Use 'request_approval' before taking any public or irreversible action.
        

CONTEXT:
{
  "currentProjectId": "p1",
  "userProfile": {
    "brandKit": {
      "tone": "Professional"
    }
  },
  "brandKit": {
    "tone": "Professional"
  },
  "chatHistory": [
    {
      "id": "1",
      "role": "user",
      "text": "Prev User",
      "timestamp": 100
    },
    {
      "id": "2",
      "role": "model",
      "text": "Prev Model",
      "timestamp": 200
    },
    {
      "id": "f0063e2d-2fa8-434d-9b17-ac244fac0cb1",
      "role": "user",
      "text": "New Message",
      "timestamp": 1765030235936
    },
    {
      "id": "655e4592-696b-4244-b36c-a789b3b0d657",
      "role": "model",
      "text": "",
      "timestamp": 1765030236033,
      "isStreaming": true,
      "thoughts": [
        {
          "id": "b4001fce-f4ba-4d38-befd-941dfe3b093c",
          "text": "Analyzing request: \"New Message...\"",
          "timestamp": 1765030236033,
          "type": "thought"
        }
      ]
    }
  ],
  "memoryContext": "",
  "relevantMemories": [],
  "projectId": "p1"
}

HISTORY:


TASK:
New Message

DEBUG: mockStoreState.agentHistory: [
  {
    "id": "1",
    "role": "user",
    "text": "Prev User",
    "timestamp": 100
  },
  {
    "id": "2",
    "role": "model",
    "text": "Prev Model",
    "timestamp": 200
  },
  {
    "id": "f0063e2d-2fa8-434d-9b17-ac244fac0cb1",
    "role": "user",
    "text": "New Message",
    "timestamp": 1765030235936
  },
  {
    "id": "655e4592-696b-4244-b36c-a789b3b0d657",
    "role": "model",
    "text": "Error executing task: response.functionCalls is not a function",
    "timestamp": 1765030236033,
    "isStreaming": false,
    "thoughts": [
      {
        "id": "b4001fce-f4ba-4d38-befd-941dfe3b093c",
        "text": "Analyzing request: \"New Message...\"",
        "timestamp": 1765030236033,
        "type": "thought"
      },
      {
        "id": "0f21d5d2-85e0-4cd6-b0d3-d50d8c0ab481",
        "text": "Generating response...",
        "timestamp": 1765030236033,
        "type": "thought"
      },
      {
        "id": "95463666-bfee-4088-a735-4c14585a575d",
        "text": "Error: response.functionCalls is not a function",
        "timestamp": 1765030236034,
        "type": "thought"
      }
    ]
  }
]

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Get rich

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[Finance Department] Tool Call: make_money_fast {}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Do something crazy

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:176:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[AgentService] Selected Agent: brand (Auto)
[AgentExecutor] Executing with agent: Brand Manager (brand)
[Brand Manager] Received task: Verify this

 [31mâ¯[39m src/services/agent/AgentIntegration.test.ts [2m([22m[2m7 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 1286[2mms[22m[39m
       [33m[2mâœ“[22m[39m should correctly orchestrate, execute, and return response for a specialist [33m 693[2mms[22m[39m
       [32mâœ“[39m should handle tool execution cycles (Thinking -> Tool -> Response)[32m 86[2mms[22m[39m
       [32mâœ“[39m should prevent concurrent agent executions (Lock Mechanism)[32m 142[2mms[22m[39m
[31m       [31mÃ—[31m should accumulate context correctly across multiple turns[39m[32m 108[2mms[22m[39m
       [32mâœ“[39m should handle hallucinated tool calls gracefully[32m 85[2mms[22m[39m
       [32mâœ“[39m should route to Generalist if Orchestrator hallucinations an invalid ID[32m 83[2mms[22m[39m
       [32mâœ“[39m should gracefully handle agent execution failure[32m 88[2mms[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 1 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m src/services/agent/AgentIntegration.test.ts[2m > [22mAgent Architecture Integration (Hardened)[2m > [22mState & Concurrency (Stress Test)[2m > [22mshould accumulate context correctly across multiple turns
[31m[1mAssertionError[22m: expected '\nYou are the Campaign Manager.\n    â€¦' to contain 'User: Prev User'[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- [7mUser[27m: Prev User[39m
[31m+[39m
[31m+ You are the Campaign Manager.[39m
[31m+     Your role is to design and execute comprehensive marketing campaigns.[39m
[31m+[39m
[31m+     Responsibilities:[39m
[31m+     1. Develop strategic campaign concepts.[39m
[31m+     2. Create content calendars and distribution plans.[39m
[31m+     3. Coordinate messaging across social, email, and web channels.[39m
[31m+     4. Analyze campaign performance and adjust strategy.[39m
[31m+[39m
[31m+     Think holistically about the brand's narrative and audience engagement.[39m
[31m+[39m
[31m+[39m
[31m+         **SUPERPOWERS (Agent Zero Protocol):**[39m
[31m+         - **Memory:** Use 'save_memory' to remember important details. Use 'recall_memories' to check for past context.[39m
[31m+         - **Reflection:** Use 'verify_output' to double-check your work before finalizing.[39m
[31m+         - **Approval:** Use 'request_approval' before taking any public or irreversible action.[39m
[31m+         [39m
[31m+[39m
[31m+ CONTEXT:[39m
[31m+ {[39m
[31m+   "currentProjectId": "p1",[39m
[31m+   "userProfile": {[39m
[31m+     "brandKit": {[39m
[31m+       "tone": "Professional"[39m
[31m+     }[39m
[31m+   },[39m
[31m+   "brandKit": {[39m
[31m+     "tone": "Professional"[39m
[31m+   },[39m
[31m+   "chatHistory": [[39m
[31m+     {[39m
[31m+       "id": "1",[39m
[31m+       "role": "user",[39m
[31m+ [7m      "text"[27m: [7m"[27mPrev User[7m",[27m[39m
[31m+       "timestamp": 100[39m
[31m+     },[39m
[31m+     {[39m
[31m+       "id": "2",[39m
[31m+       "role": "model",[39m
[31m+       "text": "Prev Model",[39m
[31m+       "timestamp": 200[39m
[31m+     },[39m
[31m+     {[39m
[31m+       "id": "f0063e2d-2fa8-434d-9b17-ac244fac0cb1",[39m
[31m+       "role": "user",[39m
[31m+       "text": "New Message",[39m
[31m+       "timestamp": 1765030235936[39m
[31m+     },[39m
[31m+     {[39m
[31m+       "id": "655e4592-696b-4244-b36c-a789b3b0d657",[39m
[31m+       "role": "model",[39m
[31m+       "text": "",[39m
[31m+       "timestamp": 1765030236033,[39m
[31m+       "isStreaming": true,[39m
[31m+       "thoughts": [[39m
[31m+         {[39m
[31m+           "id": "b4001fce-f4ba-4d38-befd-941dfe3b093c",[39m
[31m+           "text": "Analyzing request: \"New Message...\"",[39m
[31m+           "timestamp": 1765030236033,[39m
[31m+           "type": "thought"[39m
[31m+         }[39m
[31m+       ][39m
[31m+     }[39m
[31m+   ],[39m
[31m+   "memoryContext": "",[39m
[31m+   "relevantMemories": [],[39m
[31m+   "projectId": "p1"[39m
[31m+ }[39m
[31m+[39m
[31m+ HISTORY:[39m
[31m+[39m
[31m+[39m
[31m+ TASK:[39m
[31m+ New Message[39m
[31m+[39m

[36m [2mâ¯[22m src/services/agent/AgentIntegration.test.ts:[2m146:35[22m[39m
    [90m144| [39m            // We need to verify that ContextPipeline built the stringâ€¦
    [90m145| [39m            // The mock store has the messages, ContextPipeline reads â€¦
    [90m146| [39m            [34mexpect[39m(historyString)[33m.[39m[34mtoContain[39m([32m'User: Prev User'[39m)[33m;[39m
    [90m   | [39m                                  [31m^[39m
    [90m147| [39m            [34mexpect[39m(historyString)[33m.[39m[34mtoContain[39m([32m'Assistant: Prev Model'[39m)[33m;[39m
    [90m148| [39m        })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/1]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m6 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 09:10:33
[2m   Duration [22m 2.88s[2m (transform 171ms, setup 213ms, import 195ms, tests 1.29s, environment 983ms)[22m

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2msrc/core/store/slices/authSlice.ts [22m[34mx1 [34m[39m
       [2m Filename pattern: [22m[34msrc/services/agent/AgentIntegration.test.ts[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mUsing partial/invalid config due to validation errors.

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts
[22m[39m[AgentRegistry] Registered: Marketing Department (marketing)
[AgentRegistry] Registered: Legal Department (legal)
[AgentRegistry] Registered: Finance Department (finance)
[AgentRegistry] Registered: Music Supervisor (music)
[AgentRegistry] Registered: Creative Director (director)
[AgentRegistry] Registered: Video Department (video)
[AgentRegistry] Registered: Social Media Department (social)
[AgentRegistry] Registered: Publicist (publicist)
[AgentRegistry] Registered: Road Manager (road)
[AgentRegistry] Registered: Publishing Department (publishing)
[AgentRegistry] Registered: Licensing Department (licensing)
[AgentRegistry] Registered: Brand Manager (brand)
[AgentRegistry] Registered: Agent Zero (generalist)

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[2025-12-06T14:11:24.181Z]  @firebase/firestore: Firestore (12.6.0): Error using user provided cache. Falling back to memory cache: FirebaseError: [code=unimplemented]: IndexedDB persistence is only available on platforms that support LocalStorage.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mFirebaseError: Firebase: Error (auth/too-many-requests).
    at createErrorInternal [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:499:41[90m)[39m
    at _fail [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:474:11[90m)[39m
    at _performFetchWithErrorHandling [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:961:17[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at _performSignInRequest [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:976:28[90m)[39m
    at signInAnonymously [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:5504:22[90m)[39m {
  code: [32m'auth/too-many-requests'[39m,
  customData: {}
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: Analyze market trends

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Check this budget

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[Finance Department] Tool Call: analyze_budget { amount: [33m1000[39m, breakdown: [32m'Test'[39m }

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Request 1

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at async Promise.all (index 0)
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:119:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: New Message

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[Marketing Department] Error executing task: TypeError: response.functionCalls is not a function
    at BaseAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/BaseAgent.ts:172:43[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:135:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mDEBUG: historyString: 
You are the Campaign Manager.
    Your role is to design and execute comprehensive marketing campaigns.

    Responsibilities:
    1. Develop strategic campaign concepts.
    2. Create content calendars and distribution plans.
    3. Coordinate messaging across social, email, and web channels.
    4. Analyze campaign performance and adjust strategy.

    Think holistically about the brand's narrative and audience engagement.


        **SUPERPOWERS (Agent Zero Protocol):**
        - **Memory:** Use 'save_memory' to remember important details. Use 'recall_memories' to check for past context.
        - **Reflection:** Use 'verify_output' to double-check your work before finalizing.
        - **Approval:** Use 'request_approval' before taking any public or irreversible action.
        

CONTEXT:
{
  "currentProjectId": "p1",
  "userProfile": {
    "brandKit": {
      "tone": "Professional"
    }
  },
  "brandKit": {
    "tone": "Professional"
  },
  "chatHistory": [
    {
      "id": "1",
      "role": "user",
      "text": "Prev User",
      "timestamp": 100
    },
    {
      "id": "2",
      "role": "model",
      "text": "Prev Model",
      "timestamp": 200
    },
    {
      "id": "c16e608d-3490-4f49-aec7-ad8e7b0678e3",
      "role": "user",
      "text": "New Message",
      "timestamp": 1765030286736
    },
    {
      "id": "6ea6f8d6-3e77-40c2-af8e-41f52ae782d4",
      "role": "model",
      "text": "",
      "timestamp": 1765030286838,
      "isStreaming": true,
      "thoughts": [
        {
          "id": "f839e8fa-503c-4a0a-a60f-2589b03115b4",
          "text": "Analyzing request: \"New Message...\"",
          "timestamp": 1765030286845,
          "type": "thought"
        }
      ]
    }
  ],
  "memoryContext": "",
  "relevantMemories": [],
  "projectId": "p1"
}

HISTORY:


TASK:
New Message

DEBUG: mockStoreState.agentHistory: [
  {
    "id": "1",
    "role": "user",
    "text": "Prev User",
    "timestamp": 100
  },
  {
    "id": "2",
    "role": "model",
    "text": "Prev Model",
    "timestamp": 200
  },
  {
    "id": "c16e608d-3490-4f49-aec7-ad8e7b0678e3",
    "role": "user",
    "text": "New Message",
    "timestamp": 1765030286736
  },
  {
    "id": "6ea6f8d6-3e77-40c2-af8e-41f52ae782d4",
    "role": "model",
    "text": "Error executing task: response.functionCalls is not a function",
    "timestamp": 1765030286838,
    "isStreaming": false,
    "thoughts": [
      {
        "id": "f839e8fa-503c-4a0a-a60f-2589b03115b4",
        "text": "Analyzing request: \"New Message...\"",
        "timestamp": 1765030286845,
        "type": "thought"
      },
      {
        "id": "61dea318-a0c4-4a16-a93d-1c92aa91cfe4",
        "text": "Generating response...",
        "timestamp": 1765030286845,
        "type": "thought"
      },
      {
        "id": "80d9fe76-9821-4f19-bea7-73d81dfcd661",
        "text": "Error: response.functionCalls is not a function",
        "timestamp": 1765030286846,
        "type": "thought"
      }
    ]
  }
]

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Get rich

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[Finance Department] Tool Call: make_money_fast {}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Do something crazy

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:176:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[AgentService] Selected Agent: brand (Auto)
[AgentExecutor] Executing with agent: Brand Manager (brand)
[Brand Manager] Received task: Verify this

 [31mâ¯[39m src/services/agent/AgentIntegration.test.ts [2m([22m[2m7 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 3250[2mms[22m[39m
       [33m[2mâœ“[22m[39m should correctly orchestrate, execute, and return response for a specialist [33m 1515[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle tool execution cycles (Thinking -> Tool -> Response) [33m 356[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent concurrent agent executions (Lock Mechanism) [33m 693[2mms[22m[39m
[31m       [31mÃ—[31m should accumulate context correctly across multiple turns[39m[32m 135[2mms[22m[39m
       [32mâœ“[39m should handle hallucinated tool calls gracefully[32m 141[2mms[22m[39m
       [32mâœ“[39m should route to Generalist if Orchestrator hallucinations an invalid ID[32m 184[2mms[22m[39m
       [32mâœ“[39m should gracefully handle agent execution failure[32m 218[2mms[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 1 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m src/services/agent/AgentIntegration.test.ts[2m > [22mAgent Architecture Integration (Hardened)[2m > [22mState & Concurrency (Stress Test)[2m > [22mshould accumulate context correctly across multiple turns
[31m[1mAssertionError[22m: expected '\nYou are the Campaign Manager.\n    â€¦' to contain 'User: Prev User'[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- [7mUser[27m: Prev User[39m
[31m+[39m
[31m+ You are the Campaign Manager.[39m
[31m+     Your role is to design and execute comprehensive marketing campaigns.[39m
[31m+[39m
[31m+     Responsibilities:[39m
[31m+     1. Develop strategic campaign concepts.[39m
[31m+     2. Create content calendars and distribution plans.[39m
[31m+     3. Coordinate messaging across social, email, and web channels.[39m
[31m+     4. Analyze campaign performance and adjust strategy.[39m
[31m+[39m
[31m+     Think holistically about the brand's narrative and audience engagement.[39m
[31m+[39m
[31m+[39m
[31m+         **SUPERPOWERS (Agent Zero Protocol):**[39m
[31m+         - **Memory:** Use 'save_memory' to remember important details. Use 'recall_memories' to check for past context.[39m
[31m+         - **Reflection:** Use 'verify_output' to double-check your work before finalizing.[39m
[31m+         - **Approval:** Use 'request_approval' before taking any public or irreversible action.[39m
[31m+         [39m
[31m+[39m
[31m+ CONTEXT:[39m
[31m+ {[39m
[31m+   "currentProjectId": "p1",[39m
[31m+   "userProfile": {[39m
[31m+     "brandKit": {[39m
[31m+       "tone": "Professional"[39m
[31m+     }[39m
[31m+   },[39m
[31m+   "brandKit": {[39m
[31m+     "tone": "Professional"[39m
[31m+   },[39m
[31m+   "chatHistory": [[39m
[31m+     {[39m
[31m+       "id": "1",[39m
[31m+       "role": "user",[39m
[31m+ [7m      "text"[27m: [7m"[27mPrev User[7m",[27m[39m
[31m+       "timestamp": 100[39m
[31m+     },[39m
[31m+     {[39m
[31m+       "id": "2",[39m
[31m+       "role": "model",[39m
[31m+       "text": "Prev Model",[39m
[31m+       "timestamp": 200[39m
[31m+     },[39m
[31m+     {[39m
[31m+       "id": "c16e608d-3490-4f49-aec7-ad8e7b0678e3",[39m
[31m+       "role": "user",[39m
[31m+       "text": "New Message",[39m
[31m+       "timestamp": 1765030286736[39m
[31m+     },[39m
[31m+     {[39m
[31m+       "id": "6ea6f8d6-3e77-40c2-af8e-41f52ae782d4",[39m
[31m+       "role": "model",[39m
[31m+       "text": "",[39m
[31m+       "timestamp": 1765030286838,[39m
[31m+       "isStreaming": true,[39m
[31m+       "thoughts": [[39m
[31m+         {[39m
[31m+           "id": "f839e8fa-503c-4a0a-a60f-2589b03115b4",[39m
[31m+           "text": "Analyzing request: \"New Message...\"",[39m
[31m+           "timestamp": 1765030286845,[39m
[31m+           "type": "thought"[39m
[31m+         }[39m
[31m+       ][39m
[31m+     }[39m
[31m+   ],[39m
[31m+   "memoryContext": "",[39m
[31m+   "relevantMemories": [],[39m
[31m+   "projectId": "p1"[39m
[31m+ }[39m
[31m+[39m
[31m+ HISTORY:[39m
[31m+[39m
[31m+[39m
[31m+ TASK:[39m
[31m+ New Message[39m
[31m+[39m

[90m [2mâ¯[22m src/services/agent/AgentIntegration.test.ts:[2m146:35[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/1]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m6 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 09:11:06
[2m   Duration [22m 12.14s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2msrc/services/agent/components/HistoryManager.ts [22m[34mx2 [34m[39m
       [2m Filename pattern: [22m[34msrc/services/agent/AgentIntegration.test.ts[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mUsing partial/invalid config due to validation errors.

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts
[22m[39m[AgentRegistry] Registered: Marketing Department (marketing)
[AgentRegistry] Registered: Legal Department (legal)
[AgentRegistry] Registered: Finance Department (finance)
[AgentRegistry] Registered: Music Supervisor (music)
[AgentRegistry] Registered: Creative Director (director)
[AgentRegistry] Registered: Video Department (video)
[AgentRegistry] Registered: Social Media Department (social)
[AgentRegistry] Registered: Publicist (publicist)
[AgentRegistry] Registered: Road Manager (road)
[AgentRegistry] Registered: Publishing Department (publishing)
[AgentRegistry] Registered: Licensing Department (licensing)
[AgentRegistry] Registered: Brand Manager (brand)
[AgentRegistry] Registered: Agent Zero (generalist)

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[2025-12-06T14:11:38.851Z]  @firebase/firestore: Firestore (12.6.0): Error using user provided cache. Falling back to memory cache: FirebaseError: [code=unimplemented]: IndexedDB persistence is only available on platforms that support LocalStorage.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mFirebaseError: Firebase: Error (auth/too-many-requests).
    at createErrorInternal [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:499:41[90m)[39m
    at _fail [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:474:11[90m)[39m
    at _performFetchWithErrorHandling [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:961:17[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at _performSignInRequest [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:976:28[90m)[39m
    at signInAnonymously [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:5504:22[90m)[39m {
  code: [32m'auth/too-many-requests'[39m,
  customData: {}
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: Analyze market trends

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Check this budget

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[Finance Department] Tool Call: analyze_budget { amount: [33m1000[39m, breakdown: [32m'Test'[39m }

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Request 1

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at async Promise.all (index 0)
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:119:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[HistoryManager] agentHistory length: [33m3[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: New Message

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[Marketing Department] Error executing task: TypeError: response.functionCalls is not a function
    at BaseAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/BaseAgent.ts:172:43[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:135:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mDEBUG: historyString: 
You are the Campaign Manager.
    Your role is to design and execute comprehensive marketing campaigns.

    Responsibilities:
    1. Develop strategic campaign concepts.
    2. Create content calendars and distribution plans.
    3. Coordinate messaging across social, email, and web channels.
    4. Analyze campaign performance and adjust strategy.

    Think holistically about the brand's narrative and audience engagement.


        **SUPERPOWERS (Agent Zero Protocol):**
        - **Memory:** Use 'save_memory' to remember important details. Use 'recall_memories' to check for past context.
        - **Reflection:** Use 'verify_output' to double-check your work before finalizing.
        - **Approval:** Use 'request_approval' before taking any public or irreversible action.
        

CONTEXT:
{
  "currentProjectId": "p1",
  "userProfile": {
    "brandKit": {
      "tone": "Professional"
    }
  },
  "brandKit": {
    "tone": "Professional"
  },
  "chatHistory": [
    {
      "id": "1",
      "role": "user",
      "text": "Prev User",
      "timestamp": 100
    },
    {
      "id": "2",
      "role": "model",
      "text": "Prev Model",
      "timestamp": 200
    },
    {
      "id": "a9771ec2-b4ee-4273-b8ad-b6f0777aa64d",
      "role": "user",
      "text": "New Message",
      "timestamp": 1765030300621
    },
    {
      "id": "0d280a0c-e4d8-442d-93c0-66030bf62682",
      "role": "model",
      "text": "",
      "timestamp": 1765030300722,
      "isStreaming": true,
      "thoughts": [
        {
          "id": "d0047945-9d57-4777-be4f-a61e90e79da3",
          "text": "Analyzing request: \"New Message...\"",
          "timestamp": 1765030300722,
          "type": "thought"
        }
      ]
    }
  ],
  "memoryContext": "",
  "relevantMemories": [],
  "projectId": "p1"
}

HISTORY:


TASK:
New Message

DEBUG: mockStoreState.agentHistory: [
  {
    "id": "1",
    "role": "user",
    "text": "Prev User",
    "timestamp": 100
  },
  {
    "id": "2",
    "role": "model",
    "text": "Prev Model",
    "timestamp": 200
  },
  {
    "id": "a9771ec2-b4ee-4273-b8ad-b6f0777aa64d",
    "role": "user",
    "text": "New Message",
    "timestamp": 1765030300621
  },
  {
    "id": "0d280a0c-e4d8-442d-93c0-66030bf62682",
    "role": "model",
    "text": "Error executing task: response.functionCalls is not a function",
    "timestamp": 1765030300722,
    "isStreaming": false,
    "thoughts": [
      {
        "id": "d0047945-9d57-4777-be4f-a61e90e79da3",
        "text": "Analyzing request: \"New Message...\"",
        "timestamp": 1765030300722,
        "type": "thought"
      },
      {
        "id": "68cfd413-3b27-4018-92fb-dd91e0bba6c4",
        "text": "Generating response...",
        "timestamp": 1765030300722,
        "type": "thought"
      },
      {
        "id": "181db0db-d4cf-40e9-9808-1e959dae8667",
        "text": "Error: response.functionCalls is not a function",
        "timestamp": 1765030300736,
        "type": "thought"
      }
    ]
  }
]

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Get rich

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[Finance Department] Tool Call: make_money_fast {}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Do something crazy

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:176:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[AgentService] Selected Agent: brand (Auto)
[AgentExecutor] Executing with agent: Brand Manager (brand)
[Brand Manager] Received task: Verify this

 [31mâ¯[39m src/services/agent/AgentIntegration.test.ts [2m([22m[2m7 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 2434[2mms[22m[39m
       [33m[2mâœ“[22m[39m should correctly orchestrate, execute, and return response for a specialist [33m 1385[2mms[22m[39m
       [32mâœ“[39m should handle tool execution cycles (Thinking -> Tool -> Response)[32m 241[2mms[22m[39m
       [32mâœ“[39m should prevent concurrent agent executions (Lock Mechanism)[32m 168[2mms[22m[39m
[31m       [31mÃ—[31m should accumulate context correctly across multiple turns[39m[32m 179[2mms[22m[39m
       [32mâœ“[39m should handle hallucinated tool calls gracefully[32m 182[2mms[22m[39m
       [32mâœ“[39m should route to Generalist if Orchestrator hallucinations an invalid ID[32m 146[2mms[22m[39m
       [32mâœ“[39m should gracefully handle agent execution failure[32m 107[2mms[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 1 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m src/services/agent/AgentIntegration.test.ts[2m > [22mAgent Architecture Integration (Hardened)[2m > [22mState & Concurrency (Stress Test)[2m > [22mshould accumulate context correctly across multiple turns
[31m[1mAssertionError[22m: expected '\nYou are the Campaign Manager.\n    â€¦' to contain 'User: Prev User'[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- [7mUser[27m: Prev User[39m
[31m+[39m
[31m+ You are the Campaign Manager.[39m
[31m+     Your role is to design and execute comprehensive marketing campaigns.[39m
[31m+[39m
[31m+     Responsibilities:[39m
[31m+     1. Develop strategic campaign concepts.[39m
[31m+     2. Create content calendars and distribution plans.[39m
[31m+     3. Coordinate messaging across social, email, and web channels.[39m
[31m+     4. Analyze campaign performance and adjust strategy.[39m
[31m+[39m
[31m+     Think holistically about the brand's narrative and audience engagement.[39m
[31m+[39m
[31m+[39m
[31m+         **SUPERPOWERS (Agent Zero Protocol):**[39m
[31m+         - **Memory:** Use 'save_memory' to remember important details. Use 'recall_memories' to check for past context.[39m
[31m+         - **Reflection:** Use 'verify_output' to double-check your work before finalizing.[39m
[31m+         - **Approval:** Use 'request_approval' before taking any public or irreversible action.[39m
[31m+         [39m
[31m+[39m
[31m+ CONTEXT:[39m
[31m+ {[39m
[31m+   "currentProjectId": "p1",[39m
[31m+   "userProfile": {[39m
[31m+     "brandKit": {[39m
[31m+       "tone": "Professional"[39m
[31m+     }[39m
[31m+   },[39m
[31m+   "brandKit": {[39m
[31m+     "tone": "Professional"[39m
[31m+   },[39m
[31m+   "chatHistory": [[39m
[31m+     {[39m
[31m+       "id": "1",[39m
[31m+       "role": "user",[39m
[31m+ [7m      "text"[27m: [7m"[27mPrev User[7m",[27m[39m
[31m+       "timestamp": 100[39m
[31m+     },[39m
[31m+     {[39m
[31m+       "id": "2",[39m
[31m+       "role": "model",[39m
[31m+       "text": "Prev Model",[39m
[31m+       "timestamp": 200[39m
[31m+     },[39m
[31m+     {[39m
[31m+       "id": "a9771ec2-b4ee-4273-b8ad-b6f0777aa64d",[39m
[31m+       "role": "user",[39m
[31m+       "text": "New Message",[39m
[31m+       "timestamp": 1765030300621[39m
[31m+     },[39m
[31m+     {[39m
[31m+       "id": "0d280a0c-e4d8-442d-93c0-66030bf62682",[39m
[31m+       "role": "model",[39m
[31m+       "text": "",[39m
[31m+       "timestamp": 1765030300722,[39m
[31m+       "isStreaming": true,[39m
[31m+       "thoughts": [[39m
[31m+         {[39m
[31m+           "id": "d0047945-9d57-4777-be4f-a61e90e79da3",[39m
[31m+           "text": "Analyzing request: \"New Message...\"",[39m
[31m+           "timestamp": 1765030300722,[39m
[31m+           "type": "thought"[39m
[31m+         }[39m
[31m+       ][39m
[31m+     }[39m
[31m+   ],[39m
[31m+   "memoryContext": "",[39m
[31m+   "relevantMemories": [],[39m
[31m+   "projectId": "p1"[39m
[31m+ }[39m
[31m+[39m
[31m+ HISTORY:[39m
[31m+[39m
[31m+[39m
[31m+ TASK:[39m
[31m+ New Message[39m
[31m+[39m

[36m [2mâ¯[22m src/services/agent/AgentIntegration.test.ts:[2m146:35[22m[39m
    [90m144| [39m            // We need to verify that ContextPipeline built the stringâ€¦
    [90m145| [39m            // The mock store has the messages, ContextPipeline reads â€¦
    [90m146| [39m            [34mexpect[39m(historyString)[33m.[39m[34mtoContain[39m([32m'User: Prev User'[39m)[33m;[39m
    [90m   | [39m                                  [31m^[39m
    [90m147| [39m            [34mexpect[39m(historyString)[33m.[39m[34mtoContain[39m([32m'Assistant: Prev Model'[39m)[33m;[39m
    [90m148| [39m        })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/1]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m6 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 09:11:27
[2m   Duration [22m 7.45s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2msrc/core/store/slices/authSlice.ts [22m[34mx3 [34m[39m
       [2m Filename pattern: [22m[34msrc/services/agent/AgentIntegration.test.ts[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mUsing partial/invalid config due to validation errors.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mFirebaseError: Firebase: Error (auth/too-many-requests).
    at createErrorInternal [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:499:41[90m)[39m
    at _fail [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:474:11[90m)[39m
    at _performFetchWithErrorHandling [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:961:17[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at _performSignInRequest [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:976:28[90m)[39m
    at signInAnonymously [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:5504:22[90m)[39m {
  code: [32m'auth/too-many-requests'[39m,
  customData: {}
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts
[22m[39m[AgentRegistry] Registered: Marketing Department (marketing)
[AgentRegistry] Registered: Legal Department (legal)
[AgentRegistry] Registered: Finance Department (finance)
[AgentRegistry] Registered: Music Supervisor (music)
[AgentRegistry] Registered: Creative Director (director)
[AgentRegistry] Registered: Video Department (video)
[AgentRegistry] Registered: Social Media Department (social)
[AgentRegistry] Registered: Publicist (publicist)
[AgentRegistry] Registered: Road Manager (road)
[AgentRegistry] Registered: Publishing Department (publishing)
[AgentRegistry] Registered: Licensing Department (licensing)
[AgentRegistry] Registered: Brand Manager (brand)
[AgentRegistry] Registered: Agent Zero (generalist)

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[2025-12-06T14:12:07.396Z]  @firebase/firestore: Firestore (12.6.0): Error using user provided cache. Falling back to memory cache: FirebaseError: [code=unimplemented]: IndexedDB persistence is only available on platforms that support LocalStorage.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: Analyze market trends

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Check this budget

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[Finance Department] Tool Call: analyze_budget { amount: [33m1000[39m, breakdown: [32m'Test'[39m }

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Request 1

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at async Promise.all (index 0)
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:119:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[HistoryManager] agentHistory length: [33m3[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: New Message

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[Marketing Department] Error executing task: TypeError: response.functionCalls is not a function
    at BaseAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/BaseAgent.ts:172:43[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:135:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mDEBUG: historyString: 
You are the Campaign Manager.
    Your role is to design and execute comprehensive marketing campaigns.

    Responsibilities:
    1. Develop strategic campaign concepts.
    2. Create content calendars and distribution plans.
    3. Coordinate messaging across social, email, and web channels.
    4. Analyze campaign performance and adjust strategy.

    Think holistically about the brand's narrative and audience engagement.


        **SUPERPOWERS (Agent Zero Protocol):**
        - **Memory:** Use 'save_memory' to remember important details. Use 'recall_memories' to check for past context.
        - **Reflection:** Use 'verify_output' to double-check your work before finalizing.
        - **Approval:** Use 'request_approval' before taking any public or irreversible action.
        

CONTEXT:
{
  "currentProjectId": "p1",
  "userProfile": {
    "brandKit": {
      "tone": "Professional"
    }
  },
  "brandKit": {
    "tone": "Professional"
  },
  "chatHistory": [
    {
      "id": "1",
      "role": "user",
      "text": "Prev User",
      "timestamp": 100
    },
    {
      "id": "2",
      "role": "model",
      "text": "Prev Model",
      "timestamp": 200
    },
    {
      "id": "02e73f03-89f4-4121-b1ab-f797150db3c8",
      "role": "user",
      "text": "New Message",
      "timestamp": 1765030329981
    },
    {
      "id": "74d8c610-5566-4f50-8056-154d7aa413a0",
      "role": "model",
      "text": "",
      "timestamp": 1765030330097,
      "isStreaming": true,
      "thoughts": [
        {
          "id": "eac36b2f-497b-4cd9-9071-e597bf6b040f",
          "text": "Analyzing request: \"New Message...\"",
          "timestamp": 1765030330099,
          "type": "thought"
        }
      ]
    }
  ],
  "memoryContext": "",
  "relevantMemories": [],
  "projectId": "p1"
}

HISTORY:


TASK:
New Message

DEBUG: mockStoreState.agentHistory: [
  {
    "id": "1",
    "role": "user",
    "text": "Prev User",
    "timestamp": 100
  },
  {
    "id": "2",
    "role": "model",
    "text": "Prev Model",
    "timestamp": 200
  },
  {
    "id": "02e73f03-89f4-4121-b1ab-f797150db3c8",
    "role": "user",
    "text": "New Message",
    "timestamp": 1765030329981
  },
  {
    "id": "74d8c610-5566-4f50-8056-154d7aa413a0",
    "role": "model",
    "text": "Error executing task: response.functionCalls is not a function",
    "timestamp": 1765030330097,
    "isStreaming": false,
    "thoughts": [
      {
        "id": "eac36b2f-497b-4cd9-9071-e597bf6b040f",
        "text": "Analyzing request: \"New Message...\"",
        "timestamp": 1765030330099,
        "type": "thought"
      },
      {
        "id": "29c694c3-9aec-444a-85ab-8d89e9146701",
        "text": "Generating response...",
        "timestamp": 1765030330099,
        "type": "thought"
      },
      {
        "id": "ba034e10-3349-4a5d-9500-4946e760c607",
        "text": "Error: response.functionCalls is not a function",
        "timestamp": 1765030330108,
        "type": "thought"
      }
    ]
  }
]

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Get rich

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[Finance Department] Tool Call: make_money_fast {}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Do something crazy

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
[90m    at runNextTicks (node:internal/process/task_queues:65:5)[39m
[90m    at processTimers (node:internal/timers:540:9)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:176:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[AgentService] Selected Agent: brand (Auto)
[AgentExecutor] Executing with agent: Brand Manager (brand)
[Brand Manager] Received task: Verify this

 [31mâ¯[39m src/services/agent/AgentIntegration.test.ts [2m([22m[2m7 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 3518[2mms[22m[39m
       [33m[2mâœ“[22m[39m should correctly orchestrate, execute, and return response for a specialist [33m 2221[2mms[22m[39m
       [32mâœ“[39m should handle tool execution cycles (Thinking -> Tool -> Response)[32m 103[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent concurrent agent executions (Lock Mechanism) [33m 343[2mms[22m[39m
[31m       [31mÃ—[31m should accumulate context correctly across multiple turns[39m[33m 448[2mms[22m[39m
       [32mâœ“[39m should handle hallucinated tool calls gracefully[32m 178[2mms[22m[39m
       [32mâœ“[39m should route to Generalist if Orchestrator hallucinations an invalid ID[32m 105[2mms[22m[39m
       [32mâœ“[39m should gracefully handle agent execution failure[32m 115[2mms[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 1 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m src/services/agent/AgentIntegration.test.ts[2m > [22mAgent Architecture Integration (Hardened)[2m > [22mState & Concurrency (Stress Test)[2m > [22mshould accumulate context correctly across multiple turns
[31m[1mAssertionError[22m: expected '\nYou are the Campaign Manager.\n    â€¦' to contain 'User: Prev User'[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- [7mUser[27m: Prev User[39m
[31m+[39m
[31m+ You are the Campaign Manager.[39m
[31m+     Your role is to design and execute comprehensive marketing campaigns.[39m
[31m+[39m
[31m+     Responsibilities:[39m
[31m+     1. Develop strategic campaign concepts.[39m
[31m+     2. Create content calendars and distribution plans.[39m
[31m+     3. Coordinate messaging across social, email, and web channels.[39m
[31m+     4. Analyze campaign performance and adjust strategy.[39m
[31m+[39m
[31m+     Think holistically about the brand's narrative and audience engagement.[39m
[31m+[39m
[31m+[39m
[31m+         **SUPERPOWERS (Agent Zero Protocol):**[39m
[31m+         - **Memory:** Use 'save_memory' to remember important details. Use 'recall_memories' to check for past context.[39m
[31m+         - **Reflection:** Use 'verify_output' to double-check your work before finalizing.[39m
[31m+         - **Approval:** Use 'request_approval' before taking any public or irreversible action.[39m
[31m+         [39m
[31m+[39m
[31m+ CONTEXT:[39m
[31m+ {[39m
[31m+   "currentProjectId": "p1",[39m
[31m+   "userProfile": {[39m
[31m+     "brandKit": {[39m
[31m+       "tone": "Professional"[39m
[31m+     }[39m
[31m+   },[39m
[31m+   "brandKit": {[39m
[31m+     "tone": "Professional"[39m
[31m+   },[39m
[31m+   "chatHistory": [[39m
[31m+     {[39m
[31m+       "id": "1",[39m
[31m+       "role": "user",[39m
[31m+ [7m      "text"[27m: [7m"[27mPrev User[7m",[27m[39m
[31m+       "timestamp": 100[39m
[31m+     },[39m
[31m+     {[39m
[31m+       "id": "2",[39m
[31m+       "role": "model",[39m
[31m+       "text": "Prev Model",[39m
[31m+       "timestamp": 200[39m
[31m+     },[39m
[31m+     {[39m
[31m+       "id": "02e73f03-89f4-4121-b1ab-f797150db3c8",[39m
[31m+       "role": "user",[39m
[31m+       "text": "New Message",[39m
[31m+       "timestamp": 1765030329981[39m
[31m+     },[39m
[31m+     {[39m
[31m+       "id": "74d8c610-5566-4f50-8056-154d7aa413a0",[39m
[31m+       "role": "model",[39m
[31m+       "text": "",[39m
[31m+       "timestamp": 1765030330097,[39m
[31m+       "isStreaming": true,[39m
[31m+       "thoughts": [[39m
[31m+         {[39m
[31m+           "id": "eac36b2f-497b-4cd9-9071-e597bf6b040f",[39m
[31m+           "text": "Analyzing request: \"New Message...\"",[39m
[31m+           "timestamp": 1765030330099,[39m
[31m+           "type": "thought"[39m
[31m+         }[39m
[31m+       ][39m
[31m+     }[39m
[31m+   ],[39m
[31m+   "memoryContext": "",[39m
[31m+   "relevantMemories": [],[39m
[31m+   "projectId": "p1"[39m
[31m+ }[39m
[31m+[39m
[31m+ HISTORY:[39m
[31m+[39m
[31m+[39m
[31m+ TASK:[39m
[31m+ New Message[39m
[31m+[39m

[36m [2mâ¯[22m src/services/agent/AgentIntegration.test.ts:[2m146:35[22m[39m
    [90m144| [39m            // We need to verify that ContextPipeline built the stringâ€¦
    [90m145| [39m            // The mock store has the messages, ContextPipeline reads â€¦
    [90m146| [39m            [34mexpect[39m(historyString)[33m.[39m[34mtoContain[39m([32m'User: Prev User'[39m)[33m;[39m
    [90m   | [39m                                  [31m^[39m
    [90m147| [39m            [34mexpect[39m(historyString)[33m.[39m[34mtoContain[39m([32m'Assistant: Prev Model'[39m)[33m;[39m
    [90m148| [39m        })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/1]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m6 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 09:11:51
[2m   Duration [22m 8.72s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2msrc/services/agent/components/AgentExecutor.ts [22m[34mx4 [34m[39m
       [2m Filename pattern: [22m[34msrc/services/agent/AgentIntegration.test.ts[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mUsing partial/invalid config due to validation errors.

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts
[22m[39m[AgentRegistry] Registered: Marketing Department (marketing)
[AgentRegistry] Registered: Legal Department (legal)
[AgentRegistry] Registered: Finance Department (finance)
[AgentRegistry] Registered: Music Supervisor (music)
[AgentRegistry] Registered: Creative Director (director)
[AgentRegistry] Registered: Video Department (video)
[AgentRegistry] Registered: Social Media Department (social)
[AgentRegistry] Registered: Publicist (publicist)
[AgentRegistry] Registered: Road Manager (road)
[AgentRegistry] Registered: Publishing Department (publishing)
[AgentRegistry] Registered: Licensing Department (licensing)
[AgentRegistry] Registered: Brand Manager (brand)
[AgentRegistry] Registered: Agent Zero (generalist)

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mFirebaseError: Firebase: Error (auth/too-many-requests).
    at createErrorInternal [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:499:41[90m)[39m
    at _fail [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:474:11[90m)[39m
    at _performFetchWithErrorHandling [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:961:17[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at _performSignInRequest [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:976:28[90m)[39m
    at signInAnonymously [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:5504:22[90m)[39m {
  code: [32m'auth/too-many-requests'[39m,
  customData: {}
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[2025-12-06T14:13:15.969Z]  @firebase/firestore: Firestore (12.6.0): Error using user provided cache. Falling back to memory cache: FirebaseError: [code=unimplemented]: IndexedDB persistence is only available on platforms that support LocalStorage.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: Analyze market trends

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Check this budget

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[Finance Department] Tool Call: analyze_budget { amount: [33m1000[39m, breakdown: [32m'Test'[39m }

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Request 1

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at async Promise.all (index 0)
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:119:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[HistoryManager] agentHistory length: [33m3[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: New Message

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[Marketing Department] Error executing task: TypeError: response.functionCalls is not a function
    at BaseAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/BaseAgent.ts:172:43[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:135:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mDEBUG: historyString: 
You are the Campaign Manager.
    Your role is to design and execute comprehensive marketing campaigns.

    Responsibilities:
    1. Develop strategic campaign concepts.
    2. Create content calendars and distribution plans.
    3. Coordinate messaging across social, email, and web channels.
    4. Analyze campaign performance and adjust strategy.

    Think holistically about the brand's narrative and audience engagement.


        **SUPERPOWERS (Agent Zero Protocol):**
        - **Memory:** Use 'save_memory' to remember important details. Use 'recall_memories' to check for past context.
        - **Reflection:** Use 'verify_output' to double-check your work before finalizing.
        - **Approval:** Use 'request_approval' before taking any public or irreversible action.
        

CONTEXT:
{
  "currentProjectId": "p1",
  "userProfile": {
    "brandKit": {
      "tone": "Professional"
    }
  },
  "brandKit": {
    "tone": "Professional"
  },
  "chatHistory": [
    {
      "id": "1",
      "role": "user",
      "text": "Prev User",
      "timestamp": 100
    },
    {
      "id": "2",
      "role": "model",
      "text": "Prev Model",
      "timestamp": 200
    },
    {
      "id": "0bbe1746-ce66-49d7-b01e-26851e6cc783",
      "role": "user",
      "text": "New Message",
      "timestamp": 1765030397675
    },
    {
      "id": "905ffd8c-f687-4a44-bea2-37754c9abb2d",
      "role": "model",
      "text": "",
      "timestamp": 1765030397780,
      "isStreaming": true,
      "thoughts": [
        {
          "id": "d0b73ad0-f694-474d-970c-05c75f5ea293",
          "text": "Analyzing request: \"New Message...\"",
          "timestamp": 1765030397780,
          "type": "thought"
        }
      ]
    }
  ],
  "chatHistoryString": "User: Prev User\nAssistant: Prev Model\nUser: New Message",
  "memoryContext": "",
  "relevantMemories": [],
  "projectId": "p1"
}

HISTORY:
User: Prev User
Assistant: Prev Model
User: New Message

TASK:
New Message

DEBUG: mockStoreState.agentHistory: [
  {
    "id": "1",
    "role": "user",
    "text": "Prev User",
    "timestamp": 100
  },
  {
    "id": "2",
    "role": "model",
    "text": "Prev Model",
    "timestamp": 200
  },
  {
    "id": "0bbe1746-ce66-49d7-b01e-26851e6cc783",
    "role": "user",
    "text": "New Message",
    "timestamp": 1765030397675
  },
  {
    "id": "905ffd8c-f687-4a44-bea2-37754c9abb2d",
    "role": "model",
    "text": "Error executing task: response.functionCalls is not a function",
    "timestamp": 1765030397780,
    "isStreaming": false,
    "thoughts": [
      {
        "id": "d0b73ad0-f694-474d-970c-05c75f5ea293",
        "text": "Analyzing request: \"New Message...\"",
        "timestamp": 1765030397780,
        "type": "thought"
      },
      {
        "id": "52e2447a-7539-4eb6-8f66-16f73a99a3fa",
        "text": "Generating response...",
        "timestamp": 1765030397780,
        "type": "thought"
      },
      {
        "id": "98598c2f-e3ac-4c8b-94fd-584ed67f4f88",
        "text": "Error: response.functionCalls is not a function",
        "timestamp": 1765030397781,
        "type": "thought"
      }
    ]
  }
]

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Get rich

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[Finance Department] Tool Call: make_money_fast {}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Do something crazy

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:176:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[HistoryManager] agentHistory length: [33m1[39m

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[AgentService] Selected Agent: brand (Auto)
[AgentExecutor] Executing with agent: Brand Manager (brand)
[Brand Manager] Received task: Verify this

 [32mâœ“[39m src/services/agent/AgentIntegration.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 2275[2mms[22m[39m
       [33m[2mâœ“[22m[39m should correctly orchestrate, execute, and return response for a specialist [33m 1053[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m7 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 09:13:09
[2m   Duration [22m 4.49s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2msrc/services/agent/components/HistoryManager.ts [22m[34mx5 [34m[39m
       [2m Filename pattern: [22m[34msrc/services/agent/AgentIntegration.test.ts[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mUsing partial/invalid config due to validation errors.

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts
[22m[39m[AgentRegistry] Registered: Marketing Department (marketing)
[AgentRegistry] Registered: Legal Department (legal)
[AgentRegistry] Registered: Finance Department (finance)
[AgentRegistry] Registered: Music Supervisor (music)
[AgentRegistry] Registered: Creative Director (director)
[AgentRegistry] Registered: Video Department (video)
[AgentRegistry] Registered: Social Media Department (social)
[AgentRegistry] Registered: Publicist (publicist)
[AgentRegistry] Registered: Road Manager (road)
[AgentRegistry] Registered: Publishing Department (publishing)
[AgentRegistry] Registered: Licensing Department (licensing)
[AgentRegistry] Registered: Brand Manager (brand)
[AgentRegistry] Registered: Agent Zero (generalist)

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[2025-12-06T14:13:21.138Z]  @firebase/firestore: Firestore (12.6.0): Error using user provided cache. Falling back to memory cache: FirebaseError: [code=unimplemented]: IndexedDB persistence is only available on platforms that support LocalStorage.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mFirebaseError: Firebase: Error (auth/too-many-requests).
    at createErrorInternal [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:499:41[90m)[39m
    at _fail [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:474:11[90m)[39m
    at _performFetchWithErrorHandling [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:961:17[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at _performSignInRequest [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:976:28[90m)[39m
    at signInAnonymously [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:5504:22[90m)[39m {
  code: [32m'auth/too-many-requests'[39m,
  customData: {}
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: Analyze market trends

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Check this budget

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[Finance Department] Tool Call: analyze_budget { amount: [33m1000[39m, breakdown: [32m'Test'[39m }

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Request 1

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at async Promise.all (index 0)
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:119:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: New Message

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[Marketing Department] Error executing task: TypeError: response.functionCalls is not a function
    at BaseAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/BaseAgent.ts:172:43[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:135:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mDEBUG: historyString: 
You are the Campaign Manager.
    Your role is to design and execute comprehensive marketing campaigns.

    Responsibilities:
    1. Develop strategic campaign concepts.
    2. Create content calendars and distribution plans.
    3. Coordinate messaging across social, email, and web channels.
    4. Analyze campaign performance and adjust strategy.

    Think holistically about the brand's narrative and audience engagement.


        **SUPERPOWERS (Agent Zero Protocol):**
        - **Memory:** Use 'save_memory' to remember important details. Use 'recall_memories' to check for past context.
        - **Reflection:** Use 'verify_output' to double-check your work before finalizing.
        - **Approval:** Use 'request_approval' before taking any public or irreversible action.
        

CONTEXT:
{
  "currentProjectId": "p1",
  "userProfile": {
    "brandKit": {
      "tone": "Professional"
    }
  },
  "brandKit": {
    "tone": "Professional"
  },
  "chatHistory": [
    {
      "id": "1",
      "role": "user",
      "text": "Prev User",
      "timestamp": 100
    },
    {
      "id": "2",
      "role": "model",
      "text": "Prev Model",
      "timestamp": 200
    },
    {
      "id": "7420559f-5aad-4690-b586-f0874ac1933a",
      "role": "user",
      "text": "New Message",
      "timestamp": 1765030402636
    },
    {
      "id": "fb8b1ce2-d3ed-4e39-be15-99e1ecf5d601",
      "role": "model",
      "text": "",
      "timestamp": 1765030402762,
      "isStreaming": true,
      "thoughts": [
        {
          "id": "40a48a13-e8fb-443f-ade9-b643098784fd",
          "text": "Analyzing request: \"New Message...\"",
          "timestamp": 1765030402763,
          "type": "thought"
        }
      ]
    }
  ],
  "chatHistoryString": "User: Prev User\nAssistant: Prev Model\nUser: New Message",
  "memoryContext": "",
  "relevantMemories": [],
  "projectId": "p1"
}

HISTORY:
User: Prev User
Assistant: Prev Model
User: New Message

TASK:
New Message

DEBUG: mockStoreState.agentHistory: [
  {
    "id": "1",
    "role": "user",
    "text": "Prev User",
    "timestamp": 100
  },
  {
    "id": "2",
    "role": "model",
    "text": "Prev Model",
    "timestamp": 200
  },
  {
    "id": "7420559f-5aad-4690-b586-f0874ac1933a",
    "role": "user",
    "text": "New Message",
    "timestamp": 1765030402636
  },
  {
    "id": "fb8b1ce2-d3ed-4e39-be15-99e1ecf5d601",
    "role": "model",
    "text": "Error executing task: response.functionCalls is not a function",
    "timestamp": 1765030402762,
    "isStreaming": false,
    "thoughts": [
      {
        "id": "40a48a13-e8fb-443f-ade9-b643098784fd",
        "text": "Analyzing request: \"New Message...\"",
        "timestamp": 1765030402763,
        "type": "thought"
      },
      {
        "id": "bc5d1e67-0057-450a-8dae-376919c33a7e",
        "text": "Generating response...",
        "timestamp": 1765030402763,
        "type": "thought"
      },
      {
        "id": "b8cfe981-28af-493f-afaf-0bcd42624618",
        "text": "Error: response.functionCalls is not a function",
        "timestamp": 1765030402765,
        "type": "thought"
      }
    ]
  }
]

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Get rich

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[Finance Department] Tool Call: make_money_fast {}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Do something crazy

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:176:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[AgentService] Selected Agent: brand (Auto)
[AgentExecutor] Executing with agent: Brand Manager (brand)
[Brand Manager] Received task: Verify this

 [32mâœ“[39m src/services/agent/AgentIntegration.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 2501[2mms[22m[39m
       [33m[2mâœ“[22m[39m should correctly orchestrate, execute, and return response for a specialist [33m 1410[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m7 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 09:13:18
[2m   Duration [22m 3.75s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2msrc/services/agent/AgentIntegration.test.ts [22m[34mx6 [34m[39m
       [2m Filename pattern: [22m[34msrc/services/agent/AgentIntegration.test.ts[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mUsing partial/invalid config due to validation errors.

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts
[22m[39m[AgentRegistry] Registered: Marketing Department (marketing)
[AgentRegistry] Registered: Legal Department (legal)
[AgentRegistry] Registered: Finance Department (finance)
[AgentRegistry] Registered: Music Supervisor (music)
[AgentRegistry] Registered: Creative Director (director)
[AgentRegistry] Registered: Video Department (video)
[AgentRegistry] Registered: Social Media Department (social)
[AgentRegistry] Registered: Publicist (publicist)
[AgentRegistry] Registered: Road Manager (road)
[AgentRegistry] Registered: Publishing Department (publishing)
[AgentRegistry] Registered: Licensing Department (licensing)
[AgentRegistry] Registered: Brand Manager (brand)
[AgentRegistry] Registered: Agent Zero (generalist)

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[2025-12-06T14:13:33.091Z]  @firebase/firestore: Firestore (12.6.0): Error using user provided cache. Falling back to memory cache: FirebaseError: [code=unimplemented]: IndexedDB persistence is only available on platforms that support LocalStorage.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mFirebaseError: Firebase: Error (auth/too-many-requests).
    at createErrorInternal [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:499:41[90m)[39m
    at _fail [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:474:11[90m)[39m
    at _performFetchWithErrorHandling [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:961:17[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at _performSignInRequest [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:976:28[90m)[39m
    at signInAnonymously [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:5504:22[90m)[39m {
  code: [32m'auth/too-many-requests'[39m,
  customData: {}
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: Analyze market trends

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Check this budget

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[Finance Department] Tool Call: analyze_budget { amount: [33m1000[39m, breakdown: [32m'Test'[39m }

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Request 1

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at async Promise.all (index 0)
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:119:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: New Message

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[Marketing Department] Error executing task: TypeError: response.functionCalls is not a function
    at BaseAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/BaseAgent.ts:172:43[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:135:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Get rich

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[Finance Department] Tool Call: make_money_fast {}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Do something crazy

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:173:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[AgentService] Selected Agent: brand (Auto)
[AgentExecutor] Executing with agent: Brand Manager (brand)
[Brand Manager] Received task: Verify this

 [32mâœ“[39m src/services/agent/AgentIntegration.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 2218[2mms[22m[39m
       [33m[2mâœ“[22m[39m should correctly orchestrate, execute, and return response for a specialist [33m 1072[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent concurrent agent executions (Lock Mechanism) [33m 313[2mms[22m[39m
       [33m[2mâœ“[22m[39m should gracefully handle agent execution failure [33m 306[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m7 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 09:13:27
[2m   Duration [22m 3.61s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2msrc/services/agent/specialists/verification.test.ts [22m[34mx7 [34m[39m
       [2m Filename pattern: [22m[34msrc/services/agent/AgentIntegration.test.ts[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mUsing partial/invalid config due to validation errors.

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts
[22m[39m[AgentRegistry] Registered: Marketing Department (marketing)
[AgentRegistry] Registered: Legal Department (legal)
[AgentRegistry] Registered: Finance Department (finance)
[AgentRegistry] Registered: Music Supervisor (music)
[AgentRegistry] Registered: Creative Director (director)
[AgentRegistry] Registered: Video Department (video)
[AgentRegistry] Registered: Social Media Department (social)
[AgentRegistry] Registered: Publicist (publicist)
[AgentRegistry] Registered: Road Manager (road)
[AgentRegistry] Registered: Publishing Department (publishing)
[AgentRegistry] Registered: Licensing Department (licensing)
[AgentRegistry] Registered: Brand Manager (brand)
[AgentRegistry] Registered: Agent Zero (generalist)

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mFirebaseError: Firebase: Error (auth/too-many-requests).
    at createErrorInternal [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:499:41[90m)[39m
    at _fail [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:474:11[90m)[39m
    at _performFetchWithErrorHandling [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:961:17[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at _performSignInRequest [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:976:28[90m)[39m
    at signInAnonymously [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:5504:22[90m)[39m {
  code: [32m'auth/too-many-requests'[39m,
  customData: {}
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[2025-12-06T14:21:03.165Z]  @firebase/firestore: Firestore (12.6.0): Error using user provided cache. Falling back to memory cache: FirebaseError: [code=unimplemented]: IndexedDB persistence is only available on platforms that support LocalStorage.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: Analyze market trends

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Check this budget

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[Finance Department] Tool Call: analyze_budget { amount: [33m1000[39m, breakdown: [32m'Test'[39m }

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Request 1

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at async Promise.all (index 0)
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:119:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: New Message

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[Marketing Department] Error executing task: TypeError: response.functionCalls is not a function
    at BaseAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/BaseAgent.ts:172:43[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:135:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Get rich

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[Finance Department] Tool Call: make_money_fast {}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Do something crazy

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:173:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[AgentService] Selected Agent: brand (Auto)
[AgentExecutor] Executing with agent: Brand Manager (brand)
[Brand Manager] Received task: Verify this

 [32mâœ“[39m src/services/agent/AgentIntegration.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 1950[2mms[22m[39m
       [33m[2mâœ“[22m[39m should correctly orchestrate, execute, and return response for a specialist [33m 954[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m7 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 09:20:50
[2m   Duration [22m 8.18s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2msrc/services/agent/specialists/verification.test.ts [22m[34mx8 [34m[39m
       [2m Filename pattern: [22m[34msrc/services/agent/AgentIntegration.test.ts[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mUsing partial/invalid config due to validation errors.

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts
[22m[39m[AgentRegistry] Registered: Marketing Department (marketing)
[AgentRegistry] Registered: Legal Department (legal)
[AgentRegistry] Registered: Finance Department (finance)
[AgentRegistry] Registered: Music Supervisor (music)
[AgentRegistry] Registered: Creative Director (director)
[AgentRegistry] Registered: Video Department (video)
[AgentRegistry] Registered: Social Media Department (social)
[AgentRegistry] Registered: Publicist (publicist)
[AgentRegistry] Registered: Road Manager (road)
[AgentRegistry] Registered: Publishing Department (publishing)
[AgentRegistry] Registered: Licensing Department (licensing)
[AgentRegistry] Registered: Brand Manager (brand)
[AgentRegistry] Registered: Agent Zero (generalist)

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[2025-12-06T14:21:12.110Z]  @firebase/firestore: Firestore (12.6.0): Error using user provided cache. Falling back to memory cache: FirebaseError: [code=unimplemented]: IndexedDB persistence is only available on platforms that support LocalStorage.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: Analyze market trends

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39mFirebaseError: Firebase: Error (auth/too-many-requests).
    at createErrorInternal [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:499:41[90m)[39m
    at _fail [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:474:11[90m)[39m
    at _performFetchWithErrorHandling [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:961:17[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at _performSignInRequest [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:976:28[90m)[39m
    at signInAnonymously [90m(file:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@firebase[24m/auth/dist/node-esm/totp-c8d207b9.js:5504:22[90m)[39m {
  code: [32m'auth/too-many-requests'[39m,
  customData: {}
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Check this budget

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[Finance Department] Tool Call: analyze_budget { amount: [33m1000[39m, breakdown: [32m'Test'[39m }

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Request 1

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at async Promise.all (index 0)
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:119:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: New Message

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[Marketing Department] Error executing task: TypeError: response.functionCalls is not a function
    at BaseAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/BaseAgent.ts:172:43[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:135:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Get rich

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[Finance Department] Tool Call: make_money_fast {}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Do something crazy

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:173:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[AgentService] Selected Agent: brand (Auto)
[AgentExecutor] Executing with agent: Brand Manager (brand)
[Brand Manager] Received task: Verify this

 [32mâœ“[39m src/services/agent/AgentIntegration.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 1200[2mms[22m[39m
       [33m[2mâœ“[22m[39m should correctly orchestrate, execute, and return response for a specialist [33m 441[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m7 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 09:21:05
[2m   Duration [22m 3.93s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2msrc/core/config/EndpointService.ts [22m[34mx9 [34m[39m
       [2m Filename pattern: [22m[34msrc/services/agent/AgentIntegration.test.ts[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mUsing partial/invalid config due to validation errors.

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts
[22m[39m[AgentRegistry] Registered: Marketing Department (marketing)
[AgentRegistry] Registered: Legal Department (legal)
[AgentRegistry] Registered: Finance Department (finance)
[AgentRegistry] Registered: Music Supervisor (music)
[AgentRegistry] Registered: Creative Director (director)
[AgentRegistry] Registered: Video Department (video)
[AgentRegistry] Registered: Social Media Department (social)
[AgentRegistry] Registered: Publicist (publicist)
[AgentRegistry] Registered: Road Manager (road)
[AgentRegistry] Registered: Publishing Department (publishing)
[AgentRegistry] Registered: Licensing Department (licensing)
[AgentRegistry] Registered: Brand Manager (brand)
[AgentRegistry] Registered: Agent Zero (generalist)

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[2025-12-06T14:45:01.307Z]  @firebase/firestore: Firestore (12.6.0): Error using user provided cache. Falling back to memory cache: FirebaseError: [code=unimplemented]: IndexedDB persistence is only available on platforms that support LocalStorage.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: Analyze market trends

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Check this budget

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[Finance Department] Tool Call: analyze_budget { amount: [33m1000[39m, breakdown: [32m'Test'[39m }

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Request 1

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at async Promise.all (index 0)
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:119:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: New Message

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[Marketing Department] Error executing task: TypeError: response.functionCalls is not a function
    at BaseAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/BaseAgent.ts:172:43[90m)[39m
[90m    at runNextTicks (node:internal/process/task_queues:65:5)[39m
[90m    at processTimers (node:internal/timers:540:9)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:135:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Get rich

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[Finance Department] Tool Call: make_money_fast {}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Do something crazy

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:173:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[AgentService] Selected Agent: brand (Auto)
[AgentExecutor] Executing with agent: Brand Manager (brand)
[Brand Manager] Received task: Verify this

 [32mâœ“[39m src/services/agent/AgentIntegration.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 3739[2mms[22m[39m
       [33m[2mâœ“[22m[39m should correctly orchestrate, execute, and return response for a specialist [33m 1716[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle tool execution cycles (Thinking -> Tool -> Response) [33m 658[2mms[22m[39m
       [33m[2mâœ“[22m[39m should route to Generalist if Orchestrator hallucinations an invalid ID [33m 534[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m7 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 09:44:45
[2m   Duration [22m 8.71s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2msrc/services/ai/AIService.ts [22m[34mx10 [34m[39m
       [2m Filename pattern: [22m[34msrc/services/agent/AgentIntegration.test.ts[39m

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts
[22m[39mUsing partial/invalid config due to validation errors.

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts
[22m[39m[AgentRegistry] Registered: Marketing Department (marketing)
[AgentRegistry] Registered: Legal Department (legal)
[AgentRegistry] Registered: Finance Department (finance)
[AgentRegistry] Registered: Music Supervisor (music)
[AgentRegistry] Registered: Creative Director (director)
[AgentRegistry] Registered: Video Department (video)
[AgentRegistry] Registered: Social Media Department (social)
[AgentRegistry] Registered: Publicist (publicist)
[AgentRegistry] Registered: Road Manager (road)
[AgentRegistry] Registered: Publishing Department (publishing)
[AgentRegistry] Registered: Licensing Department (licensing)
[AgentRegistry] Registered: Brand Manager (brand)
[AgentRegistry] Registered: Agent Zero (generalist)

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[2025-12-06T16:54:38.814Z]  @firebase/firestore: Firestore (12.6.0): Error using user provided cache. Falling back to memory cache: FirebaseError: [code=unimplemented]: IndexedDB persistence is only available on platforms that support LocalStorage.

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39mError listing documents in projects/p1/memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[MemoryService] Error retrieving memories: [FirebaseError: Missing or insufficient permissions.] {
  code: [32m'permission-denied'[39m,
  customData: [90mundefined[39m,
  toString: [36m[Function (anonymous)][39m
}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould correctly orchestrate, execute, and return response for a specialist
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: Analyze market trends

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Check this budget

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEnd-to-End Execution Pipeline[2m > [22m[2mshould handle tool execution cycles (Thinking -> Tool -> Response)
[22m[39m[Finance Department] Tool Call: analyze_budget { amount: [33m1000[39m, breakdown: [32m'Test'[39m }

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Request 1

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould prevent concurrent agent executions (Lock Mechanism)
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at async Promise.all (index 0)
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:119:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[AgentService] Selected Agent: marketing (Auto)
[AgentExecutor] Executing with agent: Marketing Department (marketing)
[Marketing Department] Received task: New Message

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mState & Concurrency (Stress Test)[2m > [22m[2mshould accumulate context correctly across multiple turns
[22m[39m[Marketing Department] Error executing task: TypeError: response.functionCalls is not a function
    at BaseAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/BaseAgent.ts:172:43[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:135:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[AgentService] Selected Agent: finance (Auto)
[AgentExecutor] Executing with agent: Finance Department (finance)
[Finance Department] Received task: Get rich

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mEdge Cases & Recovery[2m > [22m[2mshould handle hallucinated tool calls gracefully
[22m[39m[Finance Department] Tool Call: make_money_fast {}

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39m[AgentService] Selected Agent: generalist (Auto)
[AgentExecutor] Executing with agent: Agent Zero (generalist)
[Agent Zero] Received task: Do something crazy

[90mstderr[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould route to Generalist if Orchestrator hallucinations an invalid ID
[22m[39mGeneralist Loop Error: TypeError: __vite_ssr_import_3__.AI.generateContentStream is not a function
    at GeneralistAgent.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/specialists/GeneralistAgent.ts:140:41[90m)[39m
    at AgentExecutor.execute [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/components/AgentExecutor.ts:28:30[90m)[39m
    at AgentService.sendMessage [90m(/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentService.ts:60:28[90m)[39m
    at [90m/Volumes/X SSD 2025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39msrc/services/agent/AgentIntegration.test.ts:173:13
    at [90mfile:///Volumes/X%20SSD%202025/Users/narrowchannel/Desktop/Rndr-AI-v1/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:915:20

[90mstdout[2m | src/services/agent/AgentIntegration.test.ts[2m > [22m[2mAgent Architecture Integration (Hardened)[2m > [22m[2mRobustness & Error Handling[2m > [22m[2mshould gracefully handle agent execution failure
[22m[39m[AgentService] Selected Agent: brand (Auto)
[AgentExecutor] Executing with agent: Brand Manager (brand)
[Brand Manager] Received task: Verify this

 [32mâœ“[39m src/services/agent/AgentIntegration.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 2853[2mms[22m[39m
       [33m[2mâœ“[22m[39m should correctly orchestrate, execute, and return response for a specialist [33m 1925[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m7 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 11:54:18
[2m   Duration [22m 12.62s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
