
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rndr-AI Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Permanent+Marker&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="index.css">
    <script type="importmap">
    {
      "imports": {
        "uuid": "https://aistudiocdn.com/uuid@^13.0.0",
        "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0"
      }
    }
    </script>
</head>
<body class="bg-[#0f0f0f] text-gray-300 font-body overflow-hidden">

    <!-- VIEW: DASHBOARD (Project Grid) -->
    <div id="view-dashboard" class="hidden w-full h-screen flex flex-col p-8 overflow-y-auto">
        <h1 class="text-4xl font-bold text-white mb-8 font-special">Your Projects <span class="text-sm font-sans font-normal text-gray-500 ml-4">Rndr-AI v7.6</span></h1>
        <div id="project-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Project Cards Rendered Here -->
        </div>
    </div>

    <!-- VIEW: STUDIO (Main App) -->
    <div id="view-studio" class="flex flex-col h-screen w-full overflow-hidden">
        
        <!-- Top Navigation -->
        <nav class="h-14 border-b border-gray-800 bg-[#151515] flex items-center px-4 justify-between flex-shrink-0 z-30">
            <div class="flex items-center gap-4">
                <button id="home-btn" class="flex items-center gap-2 hover:bg-gray-800 p-1.5 rounded-lg transition-colors">
                    <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span class="font-special text-xl text-yellow-500 tracking-wider">Rndr-AI</span>
                </button>
                <div class="h-6 w-px bg-gray-700 mx-2"></div>
                <select id="project-selector" class="bg-[#0f0f0f] border border-gray-700 text-xs rounded px-2 py-1 text-gray-300 focus:ring-1 focus:ring-yellow-500 outline-none max-w-[150px]">
                    <!-- Options populated by JS -->
                </select>
                <button id="edit-bible-btn" class="flex items-center gap-1.5 text-xs bg-gray-800 hover:bg-gray-700 border border-gray-700 text-gray-300 px-3 py-1.5 rounded transition-colors">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                    Bible
                </button>
            </div>
            
            <!-- Agent R Window (Draggable, Persistent) -->
            <div id="agent-window" class="fixed hidden bg-[#0f0f0f] border border-gray-700 rounded-xl shadow-2xl z-50 flex flex-col w-72 h-[85vh] overflow-hidden resize-y transition-opacity duration-200 top-20 left-4">
                <div class="bg-[#1a1a1a] p-2 border-b border-gray-800 flex justify-between items-center cursor-move select-none">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span class="font-bold text-xs text-gray-200">Agent R</span>
                        <span class="text-[10px] bg-purple-900 text-purple-200 px-1 rounded">BETA</span>
                    </div>
                    <div class="flex gap-1">
                        <button id="agent-clear-btn" class="p-1 hover:text-red-400 text-gray-500 transition-colors" title="Clear Memory"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                        <button id="agent-minimize-btn" class="p-1 hover:text-white text-gray-500"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
                        <button id="agent-close-btn" class="p-1 hover:text-white text-gray-500"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                    </div>
                </div>
                <div id="agent-chat-container" class="flex-1 p-3 overflow-y-auto space-y-3 custom-scrollbar bg-[#0f0f0f]">
                    <!-- Chat messages -->
                </div>
                <div class="p-2 bg-[#1a1a1a] border-t border-gray-800">
                    <div class="flex gap-2">
                        <button id="agent-upload-btn" class="p-2 bg-gray-800 text-gray-400 rounded hover:text-white transition-colors" title="Upload Image/File">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                        </button>
                        <input type="file" id="agent-file-input" class="hidden" multiple accept="image/*,video/*,audio/*,application/pdf,text/plain">
                        <input id="agent-input" type="text" class="flex-1 bg-[#0f0f0f] border border-gray-700 rounded px-2 py-1 text-xs text-white focus:border-blue-500 outline-none" placeholder="Command the agent...">
                        <button id="agent-send-btn" class="p-2 bg-purple-600 hover:bg-purple-500 text-white rounded transition-colors">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Studio Mode Bar -->
        <div class="bg-[#1a1a1a] border-b border-gray-800 py-2 px-4 flex-shrink-0 z-20">
            <div class="max-w-6xl mx-auto">
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1.5 ml-1">Studio Mode</p>
                <div class="grid grid-cols-4 md:flex md:flex-row gap-1 md:gap-2">
                    <button id="mode-agent-btn" class="flex-1 md:flex-none bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs py-1.5 px-3 rounded border border-gray-700 transition-all flex items-center justify-center gap-1.5 group">
                        <div class="w-2 h-2 rounded-full bg-green-500 group-hover:animate-pulse"></div> Agent R
                    </button>
                    
                    <!-- NEW GENERATE DROPDOWN -->
                    <div class="relative flex-1 md:flex-none group">
                        <button id="mode-generate-btn" class="w-full bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs py-1.5 px-3 rounded border border-gray-700 transition-all flex items-center justify-center gap-1">
                            Generate 
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                        </button>
                        <div id="mode-generate-menu" class="hidden absolute top-full left-0 mt-1 w-32 bg-[#1a1a1a] border border-gray-700 rounded shadow-xl z-50 flex-col py-1">
                            <button id="mode-gen-image" class="text-left w-full px-3 py-2 text-xs text-gray-300 hover:bg-blue-600 hover:text-white transition-colors">Image Mode</button>
                            <button id="mode-gen-video" class="text-left w-full px-3 py-2 text-xs text-gray-300 hover:bg-purple-600 hover:text-white transition-colors">Video Mode</button>
                        </div>
                    </div>

                    <button id="mode-edit-btn" class="flex-1 md:flex-none bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs py-1.5 px-3 rounded border border-gray-700 transition-all">Edit</button>
                    <button id="mode-reference-btn" class="flex-1 md:flex-none bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs py-1.5 px-3 rounded border border-gray-700 transition-all">Reference</button>
                    <button id="mode-remix-btn" class="flex-1 md:flex-none bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs py-1.5 px-3 rounded border border-gray-700 transition-all">Remix</button>
                    <button id="mode-showroom-btn" class="flex-1 md:flex-none bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs py-1.5 px-3 rounded border border-gray-700 transition-all">Showroom</button>
                    <button id="mode-canvas-btn" class="flex-1 md:flex-none bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs py-1.5 px-3 rounded border border-gray-700 transition-all">Canvas</button>
                </div>
                <p class="text-[10px] text-gray-500 mt-2 ml-1" id="mode-desc">Create new images from text prompts.</p>
            </div>
        </div>

        <!-- Main Workspace -->
        <main class="flex-1 flex overflow-hidden relative">
            <!-- Left Sidebar (History) - Actually on Right in flex order usually, but visual left/right depends on layout -->
            <!-- Main Content Area -->
            <div class="flex-1 flex flex-col relative min-w-0 bg-[#0f0f0f]">
                
                <!-- Infinite Canvas Layer -->
                <div id="infinite-canvas-container" class="absolute inset-0 z-0 hidden">
                    <canvas id="infinite-canvas" class="block w-full h-full bg-[#111] cursor-grab active:cursor-grabbing"></canvas>
                    <div id="canvas-hud" class="absolute top-4 left-1/2 -translate-x-1/2 bg-black/80 text-white text-xs px-4 py-2 rounded-full border border-gray-700 pointer-events-none backdrop-blur shadow-lg z-10 hidden">
                        <!-- HUD Content -->
                    </div>
                    <div id="canvas-empty-state" class="absolute inset-0 flex items-center justify-center pointer-events-none hidden">
                        <div class="bg-black/60 p-6 rounded-xl border border-gray-800 text-center">
                            <svg class="w-12 h-12 text-gray-600 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <p class="text-gray-400 text-sm font-medium">Drag images from the bottom strip to start</p>
                        </div>
                    </div>
                    
                    <!-- Canvas Toolbar -->
                    <div class="absolute bottom-32 left-1/2 -translate-x-1/2 flex gap-2 bg-[#1a1a1a] p-2 rounded-full border border-gray-700 shadow-xl z-20">
                        <button id="canvas-tool-pan" class="p-2 rounded-full bg-blue-600 text-white hover:bg-blue-500 transition-colors" title="Pan Tool"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"/><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></svg></button>
                        <button id="canvas-tool-generate" class="p-2 rounded-full bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors" title="Generate/Outpaint"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3zM12 8v8M8 12h8"/></svg></button>
                        <div class="w-px bg-gray-600 mx-1"></div>
                        <button id="canvas-upload-btn" class="p-2 rounded-full bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors" title="Upload Image"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></button>
                        <button id="canvas-reset-view" class="p-2 rounded-full bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors" title="Fit to Screen"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg></button>
                        <button id="canvas-clear" class="p-2 rounded-full bg-red-900/50 text-red-300 hover:bg-red-700 transition-colors" title="Delete Selected / Clear"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                        <button id="canvas-info-btn" class="p-2 rounded-full bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors" title="Help"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg></button>
                    </div>
                    
                    <!-- Canvas Help Card -->
                    <div id="canvas-help-card" class="absolute top-20 right-4 w-64 bg-[#1a1a1a] border border-gray-700 rounded-lg p-4 shadow-2xl hidden z-30">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-white font-bold text-sm">Canvas Guide</h3>
                            <button id="close-canvas-help-btn" class="text-gray-500 hover:text-white"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                        </div>
                        <ul class="text-xs text-gray-400 space-y-2">
                            <li>âœ‹ <b>Pan Mode:</b> Drag background to move. Click image to select. Drag items from bottom strip to import.</li>
                            <li>âœ¨ <b>Generate Mode:</b> Draw a box to create. Draw OVER an image to Outpaint (extend) it.</li>
                            <li><b>Scroll:</b> Zoom in/out.</li>
                            <li><b>Delete Key:</b> Remove selected image.</li>
                        </ul>
                    </div>
                    
                    <button id="exit-canvas-btn" class="absolute top-4 left-4 bg-red-900/80 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-xs font-bold border border-red-500 z-30 flex items-center gap-2">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg> EXIT
                    </button>
                </div>

                <!-- Asset Gallery / Drop Zone -->
                <div class="p-4 flex-1 overflow-y-auto custom-scrollbar relative z-10" id="gallery-container">
                    <div class="max-w-6xl mx-auto h-full flex flex-col">
                        <div class="flex justify-between items-end mb-2 min-h-[20px]">
                            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Assets & Gallery</h3>
                            <div class="flex items-center gap-4">
                                <div id="anchor-status-el" class="hidden flex items-center gap-2">
                                    <div class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse"></div>
                                    <p class="text-[10px] font-bold text-yellow-500">Character Anchor Active</p>
                                </div>
                                <span id="selection-count-el" class="text-xs text-blue-400 font-mono">0 selected</span>
                            </div>
                        </div>
                        
                        <!-- Main Drop Zone -->
                        <div id="drop-zone" class="flex-1 border-2 border-dashed border-gray-800 rounded-xl bg-[#111] transition-colors relative flex flex-col p-4 group">
                            
                            <!-- Gallery Grid -->
                            <div id="image-gallery" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 w-full hidden">
                                <!-- Images inserted here -->
                            </div>

                            <!-- Upload Placeholder -->
                            <div id="upload-placeholder" class="text-center pointer-events-none">
                                <svg class="w-12 h-12 text-gray-700 mx-auto mb-2 group-hover:text-gray-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <p class="text-sm text-gray-500 font-medium">Drop images or audio here</p>
                            </div>
                            
                            <!-- Gallery Hint Overlay -->
                            <div id="gallery-hint" class="hidden absolute top-2 left-1/2 -translate-x-1/2 bg-black/60 text-white text-[10px] px-3 py-1 rounded-full border border-gray-700 pointer-events-none backdrop-blur-sm z-20 flex items-center gap-2">
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                                Tap image to <b>Edit Mask</b> or Select
                            </div>

                            <input type="file" id="file-input" class="hidden" multiple accept="image/*,audio/*,video/*">
                            
                            <!-- Action Bar (Floating) -->
                            <button id="gallery-action-btn" class="hidden absolute bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-xs px-6 py-2 rounded-lg shadow-xl border border-gray-700 hover:bg-red-600 transition-colors z-20 font-medium">
                                Clear All
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Input & Controls Area -->
                <div class="bg-[#151515] border-t border-gray-800 p-4 pb-32 flex-shrink-0 z-20"> <!-- Increased bottom padding for film strip -->
                    <div class="max-w-4xl mx-auto space-y-4">
                        
                        <!-- Audio Player (Hidden by default) -->
                        <div id="audio-container" class="hidden bg-gray-800/50 border border-gray-700 rounded-lg p-2 flex items-center gap-3">
                            <div class="w-8 h-8 bg-purple-900 rounded flex items-center justify-center text-purple-300">ðŸŽµ</div>
                            <div class="flex-1 min-w-0">
                                <p id="audio-filename" class="text-xs text-gray-300 truncate">Audio Track</p>
                                <audio id="audio-player" controls class="h-6 w-full mt-1"></audio>
                            </div>
                            <button id="remove-audio-btn" class="text-gray-500 hover:text-red-400 p-1"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                        </div>

                        <!-- Remix Container (RESTORED) -->
                        <div class="hidden grid grid-cols-2 gap-4">
                            <div id="remix-content-drop" class="border-2 border-dashed border-gray-700 rounded-lg p-4 h-32 flex flex-col items-center justify-center text-gray-500 cursor-pointer hover:border-blue-500 hover:bg-[#1a1a1a] transition-all relative group">
                                <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <span class="text-[10px] uppercase font-bold">Content</span>
                                <img id="remix-content-preview" class="absolute inset-0 w-full h-full object-cover hidden rounded-lg">
                            </div>
                            <div id="remix-style-drop" class="border-2 border-dashed border-gray-700 rounded-lg p-4 h-32 flex flex-col items-center justify-center text-gray-500 cursor-pointer hover:border-purple-500 hover:bg-[#1a1a1a] transition-all relative group">
                                <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path></svg>
                                <span class="text-[10px] uppercase font-bold">Style</span>
                                <img id="remix-style-preview" class="absolute inset-0 w-full h-full object-cover hidden rounded-lg">
                            </div>
                        </div>

                        <!-- Showroom Container (RESTORED) -->
                        <div id="showroom-container" class="hidden space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div id="showroom-drop-zone" class="border-2 border-dashed border-gray-700 rounded-lg p-4 h-32 flex flex-col items-center justify-center text-gray-500 cursor-pointer hover:border-purple-500 hover:bg-[#1a1a1a] transition-all relative">
                                    <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    <span class="text-[10px] uppercase font-bold">Product Asset</span>
                                    <img id="showroom-asset-preview" class="absolute inset-0 w-full h-full object-contain hidden p-2">
                                </div>
                                <div class="space-y-2">
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Product Type</label>
                                        <select id="showroom-product-type" class="w-full bg-[#1a1a1a] border border-gray-700 text-gray-300 text-xs rounded p-2 outline-none">
                                            <option value="T-Shirt">T-Shirt</option>
                                            <option value="Hoodie">Hoodie</option>
                                            <option value="Mug">Coffee Mug</option>
                                            <option value="Bottle">Water Bottle</option>
                                            <option value="Can">Soda Can</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Placement</label>
                                        <select id="showroom-placement" class="w-full bg-[#1a1a1a] border border-gray-700 text-gray-300 text-xs rounded p-2 outline-none">
                                            <option value="Center Chest">Center Chest</option>
                                            <option value="Left Pocket">Left Pocket</option>
                                            <option value="Full Print">Full Print</option>
                                            <option value="Back Centered">Back Centered</option>
                                            <option value="Sleeve">Sleeve</option>
                                        </select>
                                    </div>
                                    <button id="showroom-mockup-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold py-2 rounded">Generate Mockup</button>
                                </div>
                            </div>

                            <div class="mb-2">
                                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Scene Presets</label>
                                <div class="flex gap-2">
                                    <button class="showroom-preset-btn bg-gray-800 hover:bg-gray-700 text-gray-300 text-[10px] px-3 py-1.5 rounded border border-gray-700" data-prompt="Professional studio photography, solid neutral background, soft lighting, 4k">Studio</button>
                                    <button class="showroom-preset-btn bg-gray-800 hover:bg-gray-700 text-gray-300 text-[10px] px-3 py-1.5 rounded border border-gray-700" data-prompt="Urban street style, tokyo night city background, neon lighting, bokeh">Urban</button>
                                    <button class="showroom-preset-btn bg-gray-800 hover:bg-gray-700 text-gray-300 text-[10px] px-3 py-1.5 rounded border border-gray-700" data-prompt="Outdoor nature lifestyle, sunlight, forest background, depth of field">Nature</button>
                                    <button class="showroom-preset-btn bg-gray-800 hover:bg-gray-700 text-gray-300 text-[10px] px-3 py-1.5 rounded border border-gray-700" data-prompt="High fashion runway, spotlight, minimal aesthetic">Runway</button>
                                </div>
                            </div>

                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label class="block text-[10px] font-bold text-gray-500 uppercase">Motion</label>
                                    <button id="magic-motion-btn" class="text-[10px] text-purple-400 hover:text-purple-300 flex items-center gap-1">âœ¨ Magic Motion</button>
                                </div>
                                <textarea id="showroom-motion-prompt" class="w-full h-16 bg-[#111] border border-gray-700 rounded p-2 text-xs text-gray-300 resize-none outline-none" placeholder="Describe camera movement..."></textarea>
                                <button id="showroom-video-btn" class="w-full mt-2 bg-gray-700 text-gray-400 text-xs font-bold py-2 rounded cursor-not-allowed" disabled>Animate Scene</button>
                            </div>
                        </div>

                        <!-- Prompt Input -->
                        <div>
                            <div class="flex justify-between items-end mb-2 flex-wrap gap-2">
                                <label class="text-xs font-bold text-gray-500 uppercase tracking-widest">Prompt / Scene Description</label>
                                <div class="flex gap-2">
                                    <button id="save-prompt-btn" class="text-[10px] text-gray-400 hover:text-white flex items-center gap-1"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save</button>
                                    <button id="load-prompt-btn" class="text-[10px] text-gray-400 hover:text-white flex items-center gap-1"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg> Library</button>
                                    <div class="w-px bg-gray-700 h-3 my-auto hidden md:block"></div>
                                    <button id="magic-btn" class="text-[10px] text-purple-400 hover:text-purple-300 flex items-center gap-1 group transition-colors">
                                        <svg class="w-3 h-3 group-hover:animate-pulse" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0L14.59 9.41L24 12L14.59 14.59L12 24L9.41 14.59L0 12L9.41 9.41L12 0Z"/></svg>
                                        Magic Words
                                    </button>
                                    <button id="improve-btn" class="text-[10px] text-blue-400 hover:text-blue-300">Improve</button>
                                </div>
                            </div>
                            <div class="relative group">
                                <textarea id="prompt-el" class="w-full bg-[#111] text-white text-sm border border-gray-700 rounded-lg p-3 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none h-24 resize-none transition-all placeholder-gray-600 pr-8" placeholder="Describe the image you want to generate..."></textarea>
                                <button id="clear-prompt-btn" class="absolute top-2 right-2 text-gray-600 hover:text-white p-1 rounded bg-[#111] opacity-0 group-hover:opacity-100 transition-opacity" title="Clear Prompt">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                </button>
                            </div>
                            <div class="mt-1">
                                <p class="text-[10px] text-gray-500 italic hidden md:block" id="prompt-tip">Tip: Describe the camera movement, action, and subject clearly.</p>
                            </div>
                        </div>

                        <!-- Story Chain Controls (Context Sensitive) -->
                        <div id="story-chain-wrapper" class="bg-[#1a1a1a] border border-gray-800 rounded-lg p-3 flex flex-wrap items-center gap-4 hidden">
                            <div class="flex items-center gap-2 min-w-max">
                                <input type="checkbox" id="story-chain-checkbox" class="w-4 h-4 bg-gray-700 border-gray-600 rounded text-blue-600 focus:ring-blue-600 cursor-pointer">
                                <div>
                                    <label for="story-chain-checkbox" class="text-xs font-bold text-blue-400 cursor-pointer select-none">Story Chain (Daisy-Chain)</label>
                                    <p class="text-[10px] text-gray-500">Use last frame as base. Slider controls temporal direction (+/- 8 seconds).</p>
                                </div>
                            </div>
                            <div id="story-consistency-container" class="flex-1 flex items-center gap-3 opacity-50 pointer-events-none transition-opacity min-w-[200px]">
                                <span class="text-[10px] text-gray-500 font-mono">Past</span>
                                <input type="range" id="consistency-slider" min="0" max="100" value="50" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                <span class="text-[10px] text-gray-500 font-mono">Future</span>
                            </div>
                            <div id="time-delta-display" class="text-[10px] font-bold text-blue-400 min-w-[60px] text-right font-mono">0s (Present)</div>
                        </div>

                        <!-- PROMPT BUILDER (Accordion) -->
                        <div class="border border-gray-800 rounded-lg bg-[#1a1a1a] overflow-hidden">
                            <button id="prompt-builder-toggle" class="w-full flex items-center justify-between p-3 text-left hover:bg-gray-800 transition-colors">
                                <span class="text-xs font-bold text-gray-200 uppercase tracking-widest flex items-center gap-2">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                                    Prompt Builder
                                </span>
                                <svg id="prompt-builder-arrow" class="w-4 h-4 text-gray-500 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div id="prompt-builder-content" class="hidden border-t border-gray-800 p-4 bg-[#111]">
                                <div id="prompt-builder-grid" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <!-- Dynamic Dropdowns -->
                                </div>
                            </div>
                        </div>

                        <!-- STUDIO CONTROL PANEL (Accordion) -->
                        <div id="studio-control-panel" class="border border-gray-800 rounded-lg bg-[#1a1a1a] overflow-hidden mt-2">
                            <button id="studio-control-toggle" class="w-full flex items-center justify-between p-3 text-left hover:bg-gray-800 transition-colors">
                                <span class="text-xs font-bold text-gray-400 uppercase tracking-widest flex items-center gap-2">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><circle cx="6.5" cy="6.5" r="1.5"></circle><circle cx="17.5" cy="6.5" r="1.5"></circle><circle cx="17.5" cy="17.5" r="1.5"></circle><circle cx="6.5" cy="17.5" r="1.5"></circle></svg>
                                    Studio Control Panel
                                </span>
                                <svg id="studio-control-arrow" class="w-4 h-4 text-gray-500 transform transition-transform duration-200 -rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div id="studio-control-content" class="hidden border-t border-gray-800 p-4 bg-[#111]">
                                <div class="grid grid-cols-2 gap-4">
                                    <!-- Aspect Ratio -->
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Aspect Ratio</label>
                                        <select id="aspect-ratio-el" class="w-full bg-[#1a1a1a] border border-gray-700 text-gray-300 text-xs rounded p-2 focus:border-blue-500 outline-none">
                                            <option value="original">Original Ratio</option>
                                            <option value="1:1">1:1 (Square)</option>
                                            <option value="16:9" selected>16:9 (Cinematic)</option>
                                            <option value="9:16">9:16 (Social)</option>
                                            <option value="4:3">4:3 (Classic)</option>
                                            <option value="3:4">3:4 (Portrait)</option>
                                        </select>
                                    </div>
                                    <!-- Resolution -->
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Resolution</label>
                                        <select id="resolution-el" class="w-full bg-[#1a1a1a] border border-gray-700 text-gray-300 text-xs rounded p-2 focus:border-blue-500 outline-none">
                                            <option value="1K">1K (Standard)</option>
                                            <option value="2K">2K (High Def)</option>
                                            <option value="4K">4K (Ultra)</option>
                                        </select>
                                    </div>
                                    <!-- Image Count -->
                                    <div id="count-container">
                                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Number of Images</label>
                                        <select id="generation-count-el" class="w-full bg-[#1a1a1a] border border-gray-700 text-gray-300 text-xs rounded p-2 focus:border-blue-500 outline-none">
                                            <option value="1" selected>1 Image</option>
                                            <option value="2">2 Images</option>
                                            <option value="4">4 Images</option>
                                            <option value="8">8 Images (Story Mode)</option>
                                        </select>
                                    </div>
                                    <!-- Negative Prompt -->
                                    <div>
                                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Negative Prompt</label>
                                        <input type="text" id="negative-prompt-input" class="w-full bg-[#1a1a1a] border border-gray-700 text-gray-300 text-xs rounded p-2 focus:border-blue-500 outline-none" placeholder="what to avoid...">
                                    </div>
                                    <!-- Seed -->
                                    <div class="col-span-2">
                                        <div class="flex items-center justify-between">
                                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Seed (Optional)</label>
                                            <span class="text-[10px] text-gray-600 cursor-help" title="Use same seed for consistency">â“˜</span>
                                        </div>
                                        <input type="number" id="seed-input" class="w-full bg-[#1a1a1a] border border-gray-700 text-gray-300 text-xs rounded p-2 focus:border-blue-500 outline-none" placeholder="Random">
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Global Film Strip (Fixed Bottom) -->
                <div id="film-strip-container" class="absolute bottom-0 left-0 right-0 h-24 md:h-32 bg-[#0a0a0a]/95 border-t border-gray-800 z-40 hidden flex items-center px-8">
                    <!-- Scroll Buttons -->
                    <button id="film-scroll-left" class="absolute left-0 top-0 bottom-0 w-8 bg-gradient-to-r from-black to-transparent flex items-center justify-center text-gray-400 hover:text-white z-50">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    </button>
                    <button id="film-scroll-right" class="absolute right-0 top-0 bottom-0 w-8 bg-gradient-to-l from-black to-transparent flex items-center justify-center text-gray-400 hover:text-white z-50">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </button>
                    
                    <div id="film-strip-list" class="flex gap-2 overflow-x-auto scrollbar-hide px-2 w-full h-full items-center snap-x snap-mandatory">
                        <!-- History Items -->
                    </div>
                </div>

                <!-- Action Bar (Generate) - Fixed Bottom Right -->
                <div class="absolute bottom-4 right-4 z-50 flex gap-2">
                    <div id="status-el" class="hidden md:flex items-center px-3 py-1 bg-black/50 text-gray-400 text-xs rounded border border-gray-800 backdrop-blur">Ready</div>
                    <button id="generate-trigger" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-blue-500/20 transition-all flex items-center gap-2">
                        <span>Generate</span>
                    </button>
                </div>

            </div>
            
            <!-- History Sidebar (Collapsible) -->
            <div id="history-sidebar" class="w-64 bg-[#111] border-l border-gray-800 flex-shrink-0 flex flex-col transform translate-x-full absolute right-0 top-0 bottom-0 transition-transform duration-300 z-40 md:relative md:translate-x-0 hidden md:flex">
                <div class="p-3 border-b border-gray-800 flex justify-between items-center bg-[#151515]">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">History</h3>
                    <div class="flex gap-1">
                        <button id="download-all-btn" class="p-1 hover:text-white text-gray-500" title="Download All"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
                        <button id="clear-history-btn" class="p-1 hover:text-red-500 text-gray-500" title="Clear History"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                        <button id="close-history-btn" class="md:hidden p-1 text-gray-400"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                    </div>
                </div>
                <div id="history-list" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar">
                    <!-- History Items -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="bible-modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1a1a1a] rounded-xl w-full max-w-2xl border border-gray-700 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-[#222]">
                <h2 class="text-lg font-bold text-white">Show Bible (Context)</h2>
                <button id="close-bible-btn" class="text-gray-400 hover:text-white"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="p-6 flex-1 overflow-y-auto">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Project Name</label>
                        <input id="bible-project-name" type="text" class="w-full bg-[#111] border border-gray-700 rounded p-2 text-white focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Context / Rules</label>
                        <textarea id="bible-context" class="w-full h-64 bg-[#111] border border-gray-700 rounded p-3 text-sm text-gray-300 focus:border-blue-500 outline-none resize-none" placeholder="Define the characters, setting, visual style, and camera rules here. This context is automatically appended to every prompt generated in this project."></textarea>
                    </div>
                    
                    <!-- Informer Box -->
                    <div class="bg-blue-900/20 border border-blue-800 rounded-lg p-3 flex gap-3">
                        <div class="text-blue-400 flex-shrink-0 mt-0.5">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                        </div>
                        <div>
                            <h4 class="text-xs font-bold text-blue-300 uppercase mb-1">Pro Tip: Automatic Context</h4>
                            <p class="text-xs text-gray-400 leading-relaxed">
                                Everything you write here is <b>automatically added</b> to every single prompt you run. 
                                Use this to lock in your "Visual Style" (e.g., "Always use anamorphic lenses, teal and orange grading") so you don't have to type it every time.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-700 bg-[#222] flex justify-end">
                <button id="save-bible-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded font-bold" onclick="document.getElementById('close-bible-btn').click()">Save & Close</button>
            </div>
        </div>
    </div>

    <!-- Video Config Modal -->
    <div id="video-config-modal" class="hidden absolute top-16 left-4 right-4 md:left-auto md:right-auto md:w-96 bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-2xl z-40">
        <div class="p-3 border-b border-gray-700 flex justify-between items-center bg-[#222]">
            <h3 class="font-bold text-sm text-white flex items-center gap-2">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/></svg>
                Video Settings
            </h3>
            <button id="close-video-config-btn" class="text-gray-400 hover:text-white"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="p-4 max-h-[60vh] overflow-y-auto custom-scrollbar">
            <!-- New Grid Layout for Video Modes -->
            <div class="grid grid-cols-2 gap-2 mb-4">
                
                <label class="cursor-pointer relative">
                    <input type="radio" name="video_mode" id="draft-mode-radio" class="peer sr-only" checked>
                    <div class="bg-[#111] border border-gray-700 rounded-lg p-3 hover:border-gray-500 peer-checked:border-blue-500 peer-checked:bg-blue-900/20 transition-all text-center h-full flex flex-col items-center justify-center gap-2">
                        <svg class="w-6 h-6 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                        <div>
                            <div class="text-xs font-bold text-gray-200">Draft Mode</div>
                            <div class="text-[9px] text-gray-500 mt-0.5">Fast generation</div>
                        </div>
                    </div>
                </label>

                <label class="cursor-pointer relative">
                    <input type="radio" name="video_mode" id="agent-mode-radio" class="peer sr-only">
                    <div class="bg-[#111] border border-gray-700 rounded-lg p-3 hover:border-gray-500 peer-checked:border-green-500 peer-checked:bg-green-900/20 transition-all text-center h-full flex flex-col items-center justify-center gap-2">
                        <svg class="w-6 h-6 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><path d="M7 7h10"/><path d="M7 12h10"/><path d="M7 17h10"/></svg>
                        <div>
                            <div class="text-xs font-bold text-gray-200">Showrunner</div>
                            <div class="text-[9px] text-gray-500 mt-0.5">Agent-planned Storyboard</div>
                        </div>
                    </div>
                </label>

                <label class="cursor-pointer relative">
                    <input type="radio" name="video_mode" id="infinite-reel-radio" class="peer sr-only">
                    <div class="bg-[#111] border border-gray-700 rounded-lg p-3 hover:border-gray-500 peer-checked:border-purple-500 peer-checked:bg-purple-900/20 transition-all text-center h-full flex flex-col items-center justify-center gap-2">
                        <svg class="w-6 h-6 text-purple-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 8c0-2.2 1.8-4 4-4s4 1.8 4 4-1.8 4-4 4-4-1.8-4-4z"/><path d="M12 12c-2.2 0-4 1.8-4 4s1.8 4 4 4 4-1.8 4-4-1.8-4-4-4z"/></svg>
                        <div>
                            <div class="text-xs font-bold text-gray-200">Infinite Reel</div>
                            <div class="text-[9px] text-gray-500 mt-0.5">Auto-extend History</div>
                        </div>
                    </div>
                </label>

                <label class="cursor-pointer relative">
                    <input type="radio" name="video_mode" id="music-mode-radio" class="peer sr-only">
                    <div class="bg-[#111] border border-gray-700 rounded-lg p-3 hover:border-gray-500 peer-checked:border-pink-500 peer-checked:bg-pink-900/20 transition-all text-center h-full flex flex-col items-center justify-center gap-2">
                        <svg class="w-6 h-6 text-pink-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                        <div>
                            <div class="text-xs font-bold text-gray-200">Music Video</div>
                            <div class="text-[9px] text-gray-500 mt-0.5">Sync visuals to Audio</div>
                        </div>
                    </div>
                </label>

                <label class="cursor-pointer relative">
                    <input type="radio" name="video_mode" id="motion-brush-radio" class="peer sr-only">
                    <div class="bg-[#111] border border-gray-700 rounded-lg p-3 hover:border-gray-500 peer-checked:border-cyan-500 peer-checked:bg-cyan-900/20 transition-all text-center h-full flex flex-col items-center justify-center gap-2">
                        <svg class="w-6 h-6 text-cyan-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 21a6 6 0 0 0 6-6c0-3.14-.9-6.25-2-9.1A29.94 29.94 0 0 0 12 2"/><path d="M12 21a6 6 0 0 1-6-6c0-3.14.9-6.25 2-9.1"/></svg>
                        <div>
                            <div class="text-xs font-bold text-gray-200">Motion Brush</div>
                            <div class="text-[9px] text-gray-500 mt-0.5">Animate Masked Area</div>
                        </div>
                    </div>
                </label>

                <label class="cursor-pointer relative">
                    <input type="radio" name="video_mode" id="keyframe-mode-radio" class="peer sr-only">
                    <div class="bg-[#111] border border-gray-700 rounded-lg p-3 hover:border-gray-500 peer-checked:border-orange-500 peer-checked:bg-orange-900/20 transition-all text-center h-full flex flex-col items-center justify-center gap-2">
                        <svg class="w-6 h-6 text-orange-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>
                        <div>
                            <div class="text-xs font-bold text-gray-200">Keyframes</div>
                            <div class="text-[9px] text-gray-500 mt-0.5">Morph Start to End</div>
                        </div>
                    </div>
                </label>

            </div>

            <div id="video-grid-instruction" class="bg-gray-800/50 border border-gray-700 rounded p-3 text-xs text-gray-400 mb-4 h-16 flex items-center justify-center text-center">
                Select a mode to see instructions.
            </div>

            <div class="border-t border-gray-700 pt-3">
                <label class="flex items-center gap-3 p-2 bg-red-900/10 border border-red-900/30 rounded cursor-pointer hover:bg-red-900/20 transition-colors">
                    <input type="checkbox" id="directors-cut-toggle" class="w-4 h-4 bg-gray-800 border-gray-600 rounded text-red-600 focus:ring-red-600 cursor-pointer">
                    <div class="flex-1">
                        <span class="text-xs font-bold text-red-400 block">Enable Director's Cut (Auto-QA)</span>
                        <span class="text-[9px] text-gray-500 block">Agent critiques and auto-retries bad generations.</span>
                    </div>
                    <svg class="w-5 h-5 text-red-800" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM8 10h8v2H8zm0 4h8v2H8z"/></svg>
                </label>
            </div>
        </div>
        <div class="p-3 bg-[#222] border-t border-gray-700 flex justify-end">
            <button class="bg-blue-600 text-white text-xs font-bold px-4 py-2 rounded" onclick="document.getElementById('close-video-config-btn').click()">Done</button>
        </div>
    </div>

    <!-- OTHER MODALS (Restored) -->
    <div id="prompt-library-modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1a1a1a] rounded-xl w-full max-w-lg border border-gray-700 shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-[#222]">
                <h2 class="text-sm font-bold text-white">Prompt Library</h2>
                <button id="close-library-btn" class="text-gray-400 hover:text-white"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div id="prompt-list" class="p-4 flex-1 overflow-y-auto space-y-2"></div>
        </div>
    </div>

    <div id="improver-modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1a1a1a] rounded-xl w-full max-w-3xl border border-gray-700 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-[#222]">
                <h2 class="text-sm font-bold text-white flex items-center gap-2"><span class="text-blue-400">âœ¨</span> Prompt Improver</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="p-6 flex-1 overflow-y-auto">
                <div class="mb-4 p-3 bg-gray-800 rounded border border-gray-700">
                    <span class="text-[10px] text-gray-500 uppercase font-bold block mb-1">Original</span>
                    <p id="original-prompt-display" class="text-xs text-gray-300 italic">...</p>
                </div>
                
                <div id="improver-loading" class="flex flex-col items-center justify-center py-12 hidden">
                    <div class="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p class="text-xs text-blue-400 animate-pulse">Consulting Expert Agent...</p>
                </div>

                <div id="improver-content" class="hidden">
                    <div id="improver-options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Options generated here -->
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-700 bg-[#222] flex justify-end gap-2">
                <button id="cancel-improvement-btn" class="px-4 py-2 text-xs text-gray-400 hover:text-white">Cancel</button>
                <button id="accept-improvement-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded font-bold text-xs" disabled>Use Selected</button>
            </div>
        </div>
    </div>

    <div id="annotation-modal" class="fixed inset-0 bg-black/90 hidden z-50 flex flex-col backdrop-blur-sm">
        <div class="h-14 bg-[#1a1a1a] border-b border-gray-700 flex items-center justify-between px-4">
            <h2 id="annotation-title" class="text-sm font-bold text-white">Edit Mask</h2>
            <div class="flex gap-2">
                <button id="save-annotation-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded text-xs font-bold">Save Mask</button>
                <button id="cancel-annotation-btn" class="text-gray-400 hover:text-white text-xs px-2">Close</button>
            </div>
        </div>
        <div class="flex-1 relative bg-[#111] overflow-hidden flex items-center justify-center select-none" id="annotation-workspace">
            <div class="relative shadow-2xl">
                <img id="annotation-image" class="max-w-[90vw] max-h-[80vh] object-contain pointer-events-none select-none">
                <canvas id="annotation-canvas" class="absolute inset-0 cursor-crosshair touch-none"></canvas>
            </div>
            
            <!-- Toolbar -->
            <div class="absolute bottom-8 left-1/2 -translate-x-1/2 bg-[#222] border border-gray-600 rounded-full p-2 flex items-center gap-2 shadow-xl">
                <div class="flex bg-gray-800 rounded-full p-1">
                    <button id="tool-brush-btn" class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13.5c0 2.2-2.5 4.5-5 4.5h-5c-2.5 0-5-2.3-5-4.5 0-3.3 3.3-7.5 10-7.5s10 4.2 10 7.5z"/></svg></button>
                    <button id="tool-eraser-btn" class="w-8 h-8 rounded-full text-gray-400 hover:text-white flex items-center justify-center"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 20H7L3 16C2 15 2 13 3 12L13 2L22 11L20 20Z"/><line x1="17" y1="17" x2="7" y2="7"/></svg></button>
                </div>
                <div class="w-px h-6 bg-gray-600"></div>
                <div class="flex items-center gap-2 px-2">
                    <span class="text-[10px] font-bold text-gray-400">SIZE</span>
                    <input type="range" id="brush-size-input" min="5" max="100" value="30" class="w-24 h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                </div>
                <div class="w-px h-6 bg-gray-600"></div>
                <button id="invert-mask-btn" class="w-8 h-8 rounded-full text-gray-400 hover:text-white flex items-center justify-center" title="Invert"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a10 10 0 0 1 0 20z"/></svg></button>
                <button id="clear-mask-btn" class="w-8 h-8 rounded-full text-gray-400 hover:text-red-400 flex items-center justify-center" title="Clear"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                
                <!-- Color Palette -->
                <div class="w-px h-6 bg-gray-600"></div>
                <div class="grid grid-cols-4 gap-1 px-1">
                    <button class="w-4 h-4 rounded-full bg-red-600 hover:scale-110 transition-transform" onclick="window.setBrushColor('rgba(220, 38, 38, 0.6)')"></button>
                    <button class="w-4 h-4 rounded-full bg-orange-500 hover:scale-110 transition-transform" onclick="window.setBrushColor('rgba(249, 115, 22, 0.6)')"></button>
                    <button class="w-4 h-4 rounded-full bg-yellow-400 hover:scale-110 transition-transform" onclick="window.setBrushColor('rgba(250, 204, 21, 0.6)')"></button>
                    <button class="w-4 h-4 rounded-full bg-green-500 hover:scale-110 transition-transform" onclick="window.setBrushColor('rgba(34, 197, 94, 0.6)')"></button>
                    <button class="w-4 h-4 rounded-full bg-blue-600 hover:scale-110 transition-transform" onclick="window.setBrushColor('rgba(37, 99, 235, 0.6)')"></button>
                    <button class="w-4 h-4 rounded-full bg-purple-600 hover:scale-110 transition-transform" onclick="window.setBrushColor('rgba(147, 51, 234, 0.6)')"></button>
                    <button class="w-4 h-4 rounded-full bg-white border border-gray-400 hover:scale-110 transition-transform" onclick="window.setBrushColor('rgba(255, 255, 255, 0.6)')"></button>
                    <button class="w-4 h-4 rounded-full bg-black border border-gray-600 hover:scale-110 transition-transform" onclick="window.setBrushColor('rgba(0, 0, 0, 0.8)')"></button>
                </div>
            </div>
        </div>
    </div>

    <div id="lightbox-modal" class="fixed inset-0 bg-black z-50 hidden flex flex-col transition-opacity duration-300 opacity-0">
        <div class="h-14 bg-[#111]/80 backdrop-blur border-b border-gray-800 flex items-center justify-between px-4 z-20">
            <div class="flex gap-4">
                <button id="lightbox-close" class="text-gray-400 hover:text-white flex items-center gap-1"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5m7-7l-7 7 7 7"/></svg> Back</button>
                <!-- NEW COMPARE BUTTON -->
                <button id="lightbox-compare-btn" class="bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-1 rounded text-xs flex items-center gap-2 border border-gray-700 select-none">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    Hold to Compare
                </button>
            </div>
            <div class="flex gap-2">
                <button id="lightbox-play-reel-btn" class="bg-purple-900/50 hover:bg-purple-600 text-purple-200 px-3 py-1.5 rounded text-xs hidden">Play Full Reel</button>
                <button id="lightbox-edit-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded text-xs font-bold">Edit</button>
                <button id="lightbox-download" class="bg-gray-800 hover:bg-white hover:text-black text-gray-300 px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Download</button>
                <button id="export-reel-btn" class="bg-gray-800 hover:bg-green-600 text-white px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 border border-gray-700"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Export Movie</button>
            </div>
        </div>
        
        <div class="flex-1 relative flex items-center justify-center bg-black overflow-hidden group">
            <button id="lightbox-prev" class="absolute left-4 p-4 text-white/50 hover:text-white hover:bg-white/10 rounded-full transition-all z-10"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
            
            <img id="lightbox-image" class="max-w-full max-h-full object-contain shadow-2xl">
            <video id="lightbox-video" class="max-w-full max-h-full hidden" controls autoplay loop playsinline></video>
            
            <button id="lightbox-next" class="absolute right-4 p-4 text-white/50 hover:text-white hover:bg-white/10 rounded-full transition-all z-10"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
            
            <div class="absolute bottom-8 left-1/2 -translate-x-1/2 text-white/50 text-xs bg-black/50 px-3 py-1 rounded-full backdrop-blur-sm pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity">
                Generating Next Frame...
            </div>
        </div>
    </div>

    <div id="storyboard-container" class="fixed inset-0 bg-[#0f0f0f] z-40 hidden flex flex-col">
        <div class="h-14 border-b border-gray-800 flex items-center justify-between px-4 bg-[#151515]">
            <h2 class="font-bold text-white flex items-center gap-2"><svg width="20" height="20" class="text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><path d="M7 7h10"/><path d="M7 12h10"/><path d="M7 17h10"/></svg> Director's Board</h2>
            <button id="close-storyboard-btn" class="text-gray-400 hover:text-white">Close</button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
            <div id="storyboard-grid" class="storyboard-grid">
                <!-- Panels -->
            </div>
        </div>
    </div>

    <!-- Agent Approval Modal -->
    <div id="agent-approval-modal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1a1a1a] rounded-xl w-full max-w-lg border border-gray-600 shadow-2xl p-6 flex flex-col gap-4">
            <h3 class="text-lg font-bold text-white">Approval Required</h3>
            <p class="text-gray-400 text-sm">Agent R needs your sign-off.</p>
            
            <!-- Image Preview for Visual Approval -->
            <div id="approval-image-container" class="hidden aspect-video bg-black rounded-lg overflow-hidden border border-gray-700">
                <img id="approval-image" class="w-full h-full object-contain">
            </div>

            <textarea id="approval-content" class="w-full h-32 bg-[#111] border border-gray-700 rounded p-3 text-sm text-gray-300 resize-none outline-none focus:border-blue-500"></textarea>
            
            <div class="flex justify-end gap-3 mt-2">
                <button id="approval-reject-btn" class="bg-red-900/50 hover:bg-red-700 text-white px-4 py-2 rounded text-xs font-bold border border-red-800">Reject & Retry</button>
                <button id="approval-approve-btn" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded text-xs font-bold">Approve</button>
            </div>
        </div>
    </div>

    <!-- Hidden Video Processor -->
    <div class="w-0 h-0 overflow-hidden">
        <video id="processor-video" crossorigin="anonymous"></video>
        <canvas id="processor-canvas"></canvas>
    </div>

    <script type="module" src="index.tsx"></script>
</body>
</html>
